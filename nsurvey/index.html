<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Community Perception & Social Context Survey</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SheetJS for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                        nepali: ['"Noto Sans Devanagari"', 'sans-serif'],
                    },
                    colors: {
                        brand: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 900: '#0c4a6e' }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        html { scroll-behavior: smooth; }
        
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .option-card {
            transition: all 0.2s;
            border: 1px solid #e2e8f0;
            position: relative;
            overflow: hidden;
        }
        .option-card:active { transform: scale(0.97); background-color: #f8fafc; }
        
        .option-card:has(input:checked) {
            border-color: #4f46e5;
            background-color: #eef2ff;
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.1);
        }
        .option-card:has(input:checked)::after {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 4px; right: 4px;
            color: #4f46e5;
            font-size: 12px;
        }

        /* Valid Input Styling from App 2 */
        input:not([type="checkbox"]):not([type="radio"]):valid:not(:placeholder-shown),
        select:valid:not([value=""]) {
            border-color: #10b981;
            background-color: #f0fdf4;
        }

        .glass-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .section-badge {
            background: linear-gradient(135deg, #4f46e5, #6366f1);
            color: white;
            box-shadow: 0 2px 4px rgba(79, 70, 229, 0.3);
        }
        
        canvas { touch-action: none; background: #fff; background-image: radial-gradient(#e2e8f0 1px, transparent 1px); background-size: 20px 20px; }
        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.3s ease-out; }
        #progress-bar { transition: width 0.3s ease; }
    </style>
</head>
<body class="pb-32 text-slate-800 antialiased" onscroll="updateProgress()">

    <!-- Header -->
    <header class="glass-header fixed top-0 left-0 right-0 z-50">
        <div class="h-1 bg-slate-200 w-full">
            <div id="progress-bar" class="h-full bg-indigo-600 w-0"></div>
        </div>
        <div class="flex flex-col md:flex-row justify-between items-center max-w-4xl mx-auto p-3 px-4 gap-3">
            <div class="flex items-center gap-3 w-full md:w-auto">
                <div class="w-10 h-10 rounded-xl bg-indigo-50 text-indigo-600 flex items-center justify-center text-lg shadow-sm">
                    <i class="fas fa-users-rays"></i>
                </div>
                <div class="leading-tight flex-1">
                    <h1 class="font-bold text-slate-900 text-sm md:text-base uppercase tracking-wide">Community Survey</h1>
                    <p class="text-[10px] text-slate-500 font-nepali">छिमेकी समुदाय धारणा तथा सामाजिक सन्दर्भ सर्वेक्षण</p>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <!-- Draft Status -->
                <span id="draftStatus" class="hidden text-[10px] bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full font-bold animate-pulse">
                    <i class="fas fa-save mr-1"></i> Draft Saved
                </span>

                <button onclick="toggleView()" id="navBtn" class="bg-slate-900 text-white px-4 py-2 rounded-lg text-xs font-bold transition active:scale-95 shadow-lg flex items-center gap-2 whitespace-nowrap">
                    <i class="fas fa-th-large"></i> Dashboard
                </button>
            </div>
        </div>
    </header>

    <div class="h-24 md:h-20"></div>

    <!-- MAIN FORM CONTAINER -->
    <div id="survey-view" class="view-section active">
        
        <!-- Restore Draft Alert -->
        <div id="restoreDraftAlert" class="hidden max-w-4xl mx-auto px-4 mb-4">
            <div class="bg-blue-50 border border-blue-200 p-4 rounded-xl flex items-center justify-between shadow-sm">
                <div>
                    <p class="text-sm font-bold text-blue-800">Unsaved draft found!</p>
                    <p class="text-xs text-blue-600">Restore previous session?</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="clearDraft()" class="text-xs text-slate-500 hover:text-slate-800 px-3 py-2">Discard</button>
                    <button onclick="restoreDraft()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-xs font-bold shadow hover:bg-blue-700">Restore</button>
                </div>
            </div>
        </div>

        <form id="mainForm" class="max-w-4xl mx-auto p-4 space-y-6" oninput="saveDraftDebounced()">
            
            <!-- CONSENT SECTION (Added from App 2) -->
            <div class="bg-indigo-50 rounded-2xl shadow-sm border border-indigo-100 overflow-hidden">
                <div class="p-5">
                    <h2 class="font-bold text-indigo-900 text-sm uppercase mb-1"><i class="fas fa-handshake mr-2"></i>Informed Consent / मञ्जुरीनामा</h2>
                    <div class="text-xs text-slate-600 space-y-2 mb-4 leading-relaxed text-justify bg-white p-3 rounded border border-indigo-100">
                        <p><strong>Project: Rural Sanitation & Community Development Initiative</strong></p>
                        <p>We are conducting a survey to understand community perception and social context. The information will be used for development planning.</p>
                        <p class="font-nepali text-slate-500">हामी सामुदायिक धारणा र सामाजिक सन्दर्भ बुझ्न यो सर्वेक्षण गर्दैछौं। प्राप्त जानकारी विकास योजनाका लागि प्रयोग गरिनेछ।</p>
                        <p>Your participation is voluntary. Answers are confidential.</p>
                        <p class="font-nepali text-slate-500">तपाईंको सहभागिता स्वैच्छिक हो र उत्तरहरू गोप्य रहनेछन्।</p>
                    </div>

                    <label class="text-xs font-bold text-slate-700 uppercase mb-2 block">Do you agree to participate? / के तपाईं सहमत हुनुहुन्छ?</label>
                    <div class="flex flex-col gap-2">
                        <label class="option-card px-4 py-3 rounded-lg bg-white cursor-pointer flex items-center gap-3">
                            <input type="radio" name="consent" value="Yes" required class="accent-indigo-600">
                            <div>
                                <span class="text-sm font-bold block">Yes, agrees to participate</span>
                                <span class="text-[10px] text-slate-500 font-nepali">हो, मञ्जुर छु</span>
                            </div>
                        </label>
                        <label class="option-card px-4 py-3 rounded-lg bg-white cursor-pointer flex items-center gap-3">
                            <input type="radio" name="consent" value="No" class="accent-red-600">
                            <div>
                                <span class="text-sm font-bold block text-red-600">No, declined</span>
                                <span class="text-[10px] text-slate-500 font-nepali">होइन, अस्वीकार गर्छु</span>
                            </div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- GPS Block -->
            <div class="bg-white p-3 rounded-lg border border-slate-200 shadow-sm">
                <label class="text-xs font-bold text-slate-500 uppercase mb-1 block">GPS Location</label>
                <div class="flex gap-2">
                    <input type="text" id="gps_input" name="gps_coords" readonly class="flex-1 bg-slate-50 border border-slate-200 rounded px-2 py-2 text-xs font-mono" placeholder="Waiting for GPS...">
                    <button type="button" id="btn_track" onclick="getGPS()" class="bg-indigo-600 text-white px-4 py-1 rounded text-xs font-bold shadow-sm hover:bg-indigo-700">
                        <i class="fas fa-location-crosshairs mr-1"></i> GPS
                    </button>
                    <button type="button" id="btn_stop" onclick="finishGPS(true)" class="hidden bg-red-500 text-white px-3 py-1 rounded text-xs font-bold shadow-sm hover:bg-red-600 animate-pulse">
                        <i class="fas fa-stop mr-1"></i>
                    </button>
                </div>
                <div id="gps_status" class="text-[10px] mt-1 text-slate-500 min-h-[1.5em]"></div>
            </div>

            <!-- SECTION 1 -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="bg-slate-50 p-4 border-b border-slate-100 flex items-center gap-3">
                    <div class="section-badge w-8 h-8 rounded-lg flex items-center justify-center font-bold text-sm">1</div>
                    <div>
                        <h2 class="font-bold text-slate-800 text-sm uppercase">Basic Information</h2>
                        <p class="font-nepali text-xs text-slate-500">खण्ड १: आधारभूत जानकारी</p>
                    </div>
                </div>
                <div class="p-5 space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-bold text-slate-600 uppercase mb-1 block">1. Settlement/Tole Name <span class="font-normal text-slate-400">| बस्ती/टोल</span></label>
                            <input type="text" name="settlement" required class="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 outline-none focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-600 uppercase mb-1 block">2. Ward No <span class="font-normal text-slate-400">| वडानम्बर</span></label>
                            <input type="number" name="ward" required class="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 outline-none focus:border-indigo-500">
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-1 block">3. Respondent Name (Optional) <span class="font-normal text-slate-400">| उत्तरदाताको नाम</span></label>
                        <input type="text" name="respondent" class="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 outline-none focus:border-indigo-500">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-bold text-slate-600 uppercase mb-1 block">4. Gender <span class="font-normal text-slate-400">| लिङ्ग</span></label>
                            <select name="gender" class="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 outline-none">
                                <option value="">Select...</option>
                                <option value="Male">Male (पुरुष)</option>
                                <option value="Female">Female (महिला)</option>
                                <option value="Other">Other (अन्य)</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-600 uppercase mb-1 block">5. Age <span class="font-normal text-slate-400">| उमेर</span></label>
                            <input type="number" name="age" class="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 outline-none">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-bold text-slate-600 uppercase mb-1 block">6. Occupation <span class="font-normal text-slate-400">| पेशा</span></label>
                            <input type="text" name="occupation" class="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 outline-none">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-600 uppercase mb-1 block">7. Years in community <span class="font-normal text-slate-400">| बसोबास अवधि</span></label>
                            <input type="number" name="years_lived" class="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 outline-none">
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION 2 -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="bg-slate-50 p-4 border-b border-slate-100 flex items-center gap-3">
                    <div class="section-badge w-8 h-8 rounded-lg flex items-center justify-center font-bold text-sm">2</div>
                    <div>
                        <h2 class="font-bold text-slate-800 text-sm uppercase">Community Relations</h2>
                        <p class="font-nepali text-xs text-slate-500">खण्ड २: समुदायबीचको सम्बन्ध</p>
                    </div>
                </div>
                <div class="p-5 space-y-5">
                    <div>
                        <label class="text-sm font-semibold text-slate-800 mb-2 block">1. How would you describe the relationship between your community and nearby settlements?</label>
                        <p class="font-nepali text-xs text-slate-500 mb-3">तपाईंको समुदाय र नजिकका बस्तीहरूबीचको सम्बन्ध कस्तो छ?</p>
                        <select name="relationship" class="w-full bg-slate-50 border border-slate-300 rounded-lg px-3 py-3 outline-none">
                            <option value="">Select...</option>
                            <option value="Very good">Very good (धेरै राम्रो)</option>
                            <option value="Good">Good (राम्रो)</option>
                            <option value="Neutral">Neutral (सामान्य)</option>
                            <option value="Weak">Weak (कमजोर)</option>
                            <option value="Poor">Poor (खराब)</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="text-sm font-semibold text-slate-800 mb-2 block">2. Do people from different settlements interact socially or economically?</label>
                        <p class="font-nepali text-xs text-slate-500 mb-3">फरक बस्तीका मानिसहरूबीच सामाजिक वा आर्थिक सम्पर्क हुन्छ?</p>
                        <div class="grid grid-cols-2 gap-2">
                            <label class="option-card px-3 py-3 rounded-lg bg-white cursor-pointer text-center">
                                <input type="radio" name="interaction" value="Frequently" class="hidden">
                                <span class="text-sm font-bold block">Frequently</span>
                                <span class="text-[10px] text-slate-500">धेरै</span>
                            </label>
                            <label class="option-card px-3 py-3 rounded-lg bg-white cursor-pointer text-center">
                                <input type="radio" name="interaction" value="Sometimes" class="hidden">
                                <span class="text-sm font-bold block">Sometimes</span>
                                <span class="text-[10px] text-slate-500">कहिलेकाहीँ</span>
                            </label>
                            <label class="option-card px-3 py-3 rounded-lg bg-white cursor-pointer text-center">
                                <input type="radio" name="interaction" value="Rarely" class="hidden">
                                <span class="text-sm font-bold block">Rarely</span>
                                <span class="text-[10px] text-slate-500">कम</span>
                            </label>
                            <label class="option-card px-3 py-3 rounded-lg bg-white cursor-pointer text-center">
                                <input type="radio" name="interaction" value="Never" class="hidden">
                                <span class="text-sm font-bold block">Never</span>
                                <span class="text-[10px] text-slate-500">हुँदैन</span>
                            </label>
                        </div>
                    </div>

                    <div>
                        <label class="text-sm font-semibold text-slate-800 mb-2 block">3. Are there shared facilities used by multiple settlements?</label>
                        <p class="font-nepali text-xs text-slate-500 mb-3">धेरै बस्तीले साझा रूपमा प्रयोग गर्ने सुविधा छन्?</p>
                        <div class="space-y-2">
                            <label class="option-card p-3 rounded-lg bg-white cursor-pointer flex items-center">
                                <input type="checkbox" name="shared_facilities" value="Water source" class="mr-3 w-4 h-4 accent-indigo-600"> 
                                <span class="text-sm">Water source (पानी)</span>
                            </label>
                            <label class="option-card p-3 rounded-lg bg-white cursor-pointer flex items-center">
                                <input type="checkbox" name="shared_facilities" value="School" class="mr-3 w-4 h-4 accent-indigo-600"> 
                                <span class="text-sm">School (विद्यालय)</span>
                            </label>
                            <label class="option-card p-3 rounded-lg bg-white cursor-pointer flex items-center">
                                <input type="checkbox" name="shared_facilities" value="Health post" class="mr-3 w-4 h-4 accent-indigo-600"> 
                                <span class="text-sm">Health post (स्वास्थ्य चौकी)</span>
                            </label>
                            <label class="option-card p-3 rounded-lg bg-white cursor-pointer flex items-center">
                                <input type="checkbox" name="shared_facilities" value="Market" class="mr-3 w-4 h-4 accent-indigo-600"> 
                                <span class="text-sm">Market (बजार)</span>
                            </label>
                            <label class="option-card p-3 rounded-lg bg-white cursor-pointer flex items-center">
                                <input type="checkbox" name="shared_facilities" value="None" class="mr-3 w-4 h-4 accent-indigo-600"> 
                                <span class="text-sm">None (छैन)</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION 3 -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="bg-slate-50 p-4 border-b border-slate-100 flex items-center gap-3">
                    <div class="section-badge w-8 h-8 rounded-lg flex items-center justify-center font-bold text-sm">3</div>
                    <div>
                        <h2 class="font-bold text-slate-800 text-sm uppercase">Local Development & Area Impact</h2>
                        <p class="font-nepali text-xs text-slate-500">खण्ड ३: स्थानीय विकास तथा क्षेत्रीय प्रभाव</p>
                    </div>
                </div>
                <div class="p-5 space-y-5">
                    <div>
                        <label class="text-sm font-semibold text-slate-800 mb-2 block">1. Priority development needs in nearby settlements?</label>
                        <p class="font-nepali text-xs text-slate-500 mb-3">नजिकका बस्तीहरूको मुख्य विकास आवश्यकता के हुन्?</p>
                        <div class="grid grid-cols-2 gap-2">
                            <label class="option-card p-2 rounded bg-white cursor-pointer flex items-center"><input type="checkbox" name="priority_needs" value="Sanitation" class="mr-2 accent-indigo-600"><span class="text-xs">Sanitation (सरसफाइ)</span></label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer flex items-center"><input type="checkbox" name="priority_needs" value="Drinking water" class="mr-2 accent-indigo-600"><span class="text-xs">Water (खानेपानी)</span></label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer flex items-center"><input type="checkbox" name="priority_needs" value="Road" class="mr-2 accent-indigo-600"><span class="text-xs">Road (सडक)</span></label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer flex items-center"><input type="checkbox" name="priority_needs" value="Health" class="mr-2 accent-indigo-600"><span class="text-xs">Health (स्वास्थ्य)</span></label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer flex items-center"><input type="checkbox" name="priority_needs" value="Education" class="mr-2 accent-indigo-600"><span class="text-xs">Education (शिक्षा)</span></label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer flex items-center"><input type="checkbox" name="priority_needs" value="Livelihood" class="mr-2 accent-indigo-600"><span class="text-xs">Livelihood (रोजगारी)</span></label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer flex items-center col-span-2"><input type="checkbox" name="priority_needs" value="Other" class="mr-2 accent-indigo-600"><span class="text-xs">Other</span></label>
                        </div>
                    </div>

                    <div>
                        <label class="text-sm font-semibold text-slate-800 mb-2 block">2. Effect of new sanitation facilities on your community?</label>
                        <p class="font-nepali text-xs text-slate-500 mb-3">नजिकै सरसफाइ संरचना बनेमा तपाईंको समुदायमा कस्तो प्रभाव पर्न सक्छ?</p>
                        <select name="impact" class="w-full bg-slate-50 border border-slate-300 rounded-lg px-3 py-3 outline-none">
                            <option value="">Select...</option>
                            <option value="No effect">No effect (कुनै प्रभाव छैन)</option>
                            <option value="Positive">Positive (सकारात्मक)</option>
                            <option value="Neutral">Neutral (सामान्य)</option>
                            <option value="Environmental concern">Environmental concern (वातावरणीय चिन्ता)</option>
                            <option value="Social concern">Social concern (सामाजिक चिन्ता)</option>
                        </select>
                    </div>

                    <div>
                        <label class="text-sm font-semibold text-slate-800 mb-2 block">3. Concerns regarding sanitation facilities?</label>
                        <p class="font-nepali text-xs text-slate-500 mb-3">नजिकै सरसफाइ संरचना बनेमा तपाईंलाई के कस्ता चिन्ता हुन सक्छ?</p>
                        <textarea name="concerns" class="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 outline-none h-20 focus:border-indigo-500" placeholder="Type here..."></textarea>
                    </div>
                </div>
            </div>

            <!-- SECTION 4 -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="bg-slate-50 p-4 border-b border-slate-100 flex items-center gap-3">
                    <div class="section-badge w-8 h-8 rounded-lg flex items-center justify-center font-bold text-sm">4</div>
                    <div>
                        <h2 class="font-bold text-slate-800 text-sm uppercase">Resource Sharing & Access</h2>
                        <p class="font-nepali text-xs text-slate-500">खण्ड ४: स्रोत उपयोग तथा पहुँच</p>
                    </div>
                </div>
                <div class="p-5 space-y-5">
                    <div>
                        <label class="text-sm font-semibold text-slate-800 mb-2 block">1. Are water sources in this area used by multiple settlements?</label>
                        <p class="font-nepali text-xs text-slate-500 mb-2">यस क्षेत्रमा पानीको स्रोत धेरै बस्तीहरूले प्रयोग गर्छन्?</p>
                        <div class="flex gap-4">
                            <label class="flex items-center gap-2"><input type="radio" name="water_shared" value="Yes" class="w-4 h-4 accent-indigo-600"> Yes (हो)</label>
                            <label class="flex items-center gap-2"><input type="radio" name="water_shared" value="No" class="w-4 h-4 accent-indigo-600"> No (होइन)</label>
                        </div>
                    </div>
                    
                    <div class="h-px bg-slate-100"></div>

                    <div>
                        <label class="text-sm font-semibold text-slate-800 mb-2 block">2. Are there informal understandings about who uses which resources?</label>
                        <p class="font-nepali text-xs text-slate-500 mb-2">कुन स्रोत कसले प्रयोग गर्ने भन्ने अनौपचारिक समझदारी छ?</p>
                        <div class="flex gap-4">
                            <label class="flex items-center gap-2"><input type="radio" name="understandings" value="Yes" class="w-4 h-4 accent-indigo-600"> Yes (छ)</label>
                            <label class="flex items-center gap-2"><input type="radio" name="understandings" value="No" class="w-4 h-4 accent-indigo-600"> No (छैन)</label>
                        </div>
                    </div>

                    <div class="h-px bg-slate-100"></div>

                    <div>
                        <label class="text-sm font-semibold text-slate-800 mb-2 block">3. Have there been disagreements in the past regarding water, land, or public space?</label>
                        <p class="font-nepali text-xs text-slate-500 mb-3">विगतमा पानी, जग्गा वा सार्वजनिक स्थान प्रयोगबारे मतभेद भएका छन्?</p>
                        <div class="flex gap-2">
                            <label class="option-card px-3 py-2 rounded-lg bg-white cursor-pointer flex-1 text-center">
                                <input type="radio" name="disagreements" value="No" class="hidden">
                                <span class="text-xs font-bold block">No</span>
                                <span class="text-[10px]">छैन</span>
                            </label>
                            <label class="option-card px-3 py-2 rounded-lg bg-white cursor-pointer flex-1 text-center">
                                <input type="radio" name="disagreements" value="Minor" class="hidden">
                                <span class="text-xs font-bold block">Minor</span>
                                <span class="text-[10px]">सानातिना</span>
                            </label>
                            <label class="option-card px-3 py-2 rounded-lg bg-white cursor-pointer flex-1 text-center">
                                <input type="radio" name="disagreements" value="Serious" class="hidden">
                                <span class="text-xs font-bold block">Serious</span>
                                <span class="text-[10px]">गम्भीर</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION 5 -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="bg-slate-50 p-4 border-b border-slate-100 flex items-center gap-3">
                    <div class="section-badge w-8 h-8 rounded-lg flex items-center justify-center font-bold text-sm">5</div>
                    <div>
                        <h2 class="font-bold text-slate-800 text-sm uppercase">Social Cooperation</h2>
                        <p class="font-nepali text-xs text-slate-500">खण्ड ५: सामाजिक सहकार्य</p>
                    </div>
                </div>
                <div class="p-5 space-y-5">
                    <div>
                        <label class="text-sm font-semibold text-slate-800 mb-2 block">1. Do people from different settlements participate together in local programs?</label>
                        <p class="font-nepali text-xs text-slate-500 mb-3">फरक बस्तीका मानिसहरू स्थानीय कार्यक्रम वा समितिमा सँगै सहभागी हुन्छन्?</p>
                        <div class="flex gap-2">
                            <label class="option-card px-3 py-2 rounded-lg bg-white cursor-pointer flex-1 text-center">
                                <input type="radio" name="participation" value="Yes" class="hidden">
                                <span class="text-xs font-bold block">Yes</span>
                                <span class="text-[10px]">हो</span>
                            </label>
                            <label class="option-card px-3 py-2 rounded-lg bg-white cursor-pointer flex-1 text-center">
                                <input type="radio" name="participation" value="Sometimes" class="hidden">
                                <span class="text-xs font-bold block">Sometimes</span>
                                <span class="text-[10px]">कहिलेकाहीँ</span>
                            </label>
                            <label class="option-card px-3 py-2 rounded-lg bg-white cursor-pointer flex-1 text-center">
                                <input type="radio" name="participation" value="No" class="hidden">
                                <span class="text-xs font-bold block">No</span>
                                <span class="text-[10px]">होइन</span>
                            </label>
                        </div>
                    </div>

                    <div>
                        <label class="text-sm font-semibold text-slate-800 mb-2 block">2. Would you be willing to cooperate in future development activities?</label>
                        <p class="font-nepali text-xs text-slate-500 mb-3">धेरै बस्तीलाई फाइदा हुने विकास कार्यमा सहकार्य गर्न इच्छुक हुनुहुन्छ?</p>
                        <div class="flex gap-2">
                            <label class="option-card px-3 py-2 rounded-lg bg-white cursor-pointer flex-1 text-center">
                                <input type="radio" name="willingness" value="Yes" class="hidden">
                                <span class="text-xs font-bold block">Yes</span>
                                <span class="text-[10px]">हो</span>
                            </label>
                            <label class="option-card px-3 py-2 rounded-lg bg-white cursor-pointer flex-1 text-center">
                                <input type="radio" name="willingness" value="Maybe" class="hidden">
                                <span class="text-xs font-bold block">Maybe</span>
                                <span class="text-[10px]">सायद</span>
                            </label>
                            <label class="option-card px-3 py-2 rounded-lg bg-white cursor-pointer flex-1 text-center">
                                <input type="radio" name="willingness" value="No" class="hidden">
                                <span class="text-xs font-bold block">No</span>
                                <span class="text-[10px]">होइन</span>
                            </label>
                        </div>
                    </div>

                    <div>
                        <label class="text-sm font-semibold text-slate-800 mb-2 block">3. Suggestions to maintain harmony between settlements?</label>
                        <p class="font-nepali text-xs text-slate-500 mb-3">बस्तीहरूबीच सद्भाव कायम राख्न के सुझाव दिनुहुन्छ?</p>
                        <textarea name="suggestions" class="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 outline-none h-24 focus:border-indigo-500" placeholder="Type suggestions here..."></textarea>
                    </div>
                </div>
            </div>

            <!-- SECTION 6 (Added) -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="bg-slate-50 p-4 border-b border-slate-100 flex items-center gap-3">
                    <div class="section-badge w-8 h-8 rounded-lg flex items-center justify-center font-bold text-sm">6</div>
                    <div>
                        <h2 class="font-bold text-slate-800 text-sm uppercase">Relationship with Local Government</h2>
                        <p class="font-nepali text-xs text-slate-500">खण्ड ६: स्थानीय तहसँगको सम्बन्ध</p>
                    </div>
                </div>
                <div class="p-5 space-y-5">
                    <div>
                        <label class="text-sm font-semibold text-slate-800 mb-2 block">1. Relationship between this settlement and Ward/Municipality office:</label>
                        <p class="font-nepali text-xs text-slate-500 mb-2">यस बस्ती र वडा/पालिकाबीचको सम्बन्ध:</p>
                        <select name="local_gov_relation" class="w-full bg-slate-50 border border-slate-300 rounded-lg px-3 py-2 outline-none">
                            <option value="Very good">Very good (धेरै राम्रो)</option>
                            <option value="Good">Good (राम्रो)</option>
                            <option value="Neutral">Neutral (सामान्य)</option>
                            <option value="Weak">Weak (कमजोर)</option>
                            <option value="Poor">Poor (खराब)</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-slate-800 mb-2 block">2. Does local government consult this settlement before projects?</label>
                        <p class="font-nepali text-xs text-slate-500 mb-2">योजना अघि स्थानीय तहले परामर्श गर्छ?</p>
                        <div class="flex gap-2">
                             <label class="option-card px-3 py-2 rounded-lg bg-white cursor-pointer flex-1 text-center"><input type="radio" name="gov_consult" value="Yes" class="hidden"><span class="text-xs font-bold block">Yes</span></label>
                             <label class="option-card px-3 py-2 rounded-lg bg-white cursor-pointer flex-1 text-center"><input type="radio" name="gov_consult" value="Sometimes" class="hidden"><span class="text-xs font-bold block">Sometimes</span></label>
                             <label class="option-card px-3 py-2 rounded-lg bg-white cursor-pointer flex-1 text-center"><input type="radio" name="gov_consult" value="Rarely" class="hidden"><span class="text-xs font-bold block">Rarely</span></label>
                             <label class="option-card px-3 py-2 rounded-lg bg-white cursor-pointer flex-1 text-center"><input type="radio" name="gov_consult" value="Never" class="hidden"><span class="text-xs font-bold block">Never</span></label>
                        </div>
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-slate-800 mb-2 block">3. Are development projects distributed fairly across settlements?</label>
                        <p class="font-nepali text-xs text-slate-500 mb-2">विकास कार्यक्रम समान रूपमा वितरण भएका छन्?</p>
                        <div class="flex gap-2">
                             <label class="option-card px-3 py-2 rounded-lg bg-white cursor-pointer flex-1 text-center"><input type="radio" name="fair_dist" value="Yes" class="hidden"><span class="text-xs font-bold block">Yes</span></label>
                             <label class="option-card px-3 py-2 rounded-lg bg-white cursor-pointer flex-1 text-center"><input type="radio" name="fair_dist" value="Somewhat" class="hidden"><span class="text-xs font-bold block">Somewhat</span></label>
                             <label class="option-card px-3 py-2 rounded-lg bg-white cursor-pointer flex-1 text-center"><input type="radio" name="fair_dist" value="No" class="hidden"><span class="text-xs font-bold block">No</span></label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION 7 (Groups & Institutions) -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="bg-slate-50 p-4 border-b border-slate-100 flex items-center gap-3">
                    <div class="section-badge w-8 h-8 rounded-lg flex items-center justify-center font-bold text-sm">7</div>
                    <div>
                        <h2 class="font-bold text-slate-800 text-sm uppercase">Community Groups & Institutions</h2>
                        <p class="font-nepali text-xs text-slate-500">खण्ड ७: सामुदायिक समूह तथा संस्था</p>
                    </div>
                </div>
                <div class="p-5 space-y-5">
                    <div>
                        <label class="text-sm font-semibold text-slate-800 mb-2 block">1. Active groups present (Select all):</label>
                        <p class="font-nepali text-xs text-slate-500 mb-2">सक्रिय समूहहरू:</p>
                        <div class="grid grid-cols-2 gap-2">
                            <label class="option-card p-2 rounded bg-white cursor-pointer flex items-center"><input type="checkbox" name="active_groups" value="Women group" class="mr-2 accent-indigo-600"><span class="text-xs">Women group</span></label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer flex items-center"><input type="checkbox" name="active_groups" value="Youth club" class="mr-2 accent-indigo-600"><span class="text-xs">Youth club</span></label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer flex items-center"><input type="checkbox" name="active_groups" value="Cooperative" class="mr-2 accent-indigo-600"><span class="text-xs">Cooperative/Financial</span></label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer flex items-center"><input type="checkbox" name="active_groups" value="Farmer group" class="mr-2 accent-indigo-600"><span class="text-xs">Farmer group</span></label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer flex items-center"><input type="checkbox" name="active_groups" value="Religious group" class="mr-2 accent-indigo-600"><span class="text-xs">Religious group</span></label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer flex items-center"><input type="checkbox" name="active_groups" value="Corporate" class="mr-2 accent-indigo-600"><span class="text-xs">Corporate/Private</span></label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer flex items-center col-span-2"><input type="checkbox" name="active_groups" value="None" class="mr-2 accent-indigo-600"><span class="text-xs">None</span></label>
                        </div>
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-slate-800 mb-2 block">2. Are these groups inclusive across settlements?</label>
                        <p class="font-nepali text-xs text-slate-500 mb-2">के यी समूहहरू विभिन्न बस्ती समेट्छन्?</p>
                        <div class="flex gap-2">
                            <label class="option-card px-3 py-2 rounded-lg bg-white cursor-pointer flex-1 text-center"><input type="radio" name="inclusive_groups" value="Yes" class="hidden"><span class="text-xs font-bold block">Yes</span></label>
                            <label class="option-card px-3 py-2 rounded-lg bg-white cursor-pointer flex-1 text-center"><input type="radio" name="inclusive_groups" value="No" class="hidden"><span class="text-xs font-bold block">No</span></label>
                            <label class="option-card px-3 py-2 rounded-lg bg-white cursor-pointer flex-1 text-center"><input type="radio" name="inclusive_groups" value="Partially" class="hidden"><span class="text-xs font-bold block">Partially</span></label>
                        </div>
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-slate-800 mb-2 block">3. Most influential group in decision making:</label>
                        <p class="font-nepali text-xs text-slate-500 mb-2">निर्णय प्रक्रियामा सबैभन्दा प्रभावशाली समूह:</p>
                        <input type="text" name="influential_group" class="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 outline-none">
                    </div>
                </div>
            </div>

            <!-- SECTION 8 (Participation) -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="bg-slate-50 p-4 border-b border-slate-100 flex items-center gap-3">
                    <div class="section-badge w-8 h-8 rounded-lg flex items-center justify-center font-bold text-sm">8</div>
                    <div>
                        <h2 class="font-bold text-slate-800 text-sm uppercase">People's Participation</h2>
                        <p class="font-nepali text-xs text-slate-500">खण्ड ८: विकासमा जनसहभागिता</p>
                    </div>
                </div>
                <div class="p-5 space-y-5">
                    <div>
                        <label class="text-sm font-semibold text-slate-800 mb-2 block">1. Forms of participation (Select all):</label>
                        <p class="font-nepali text-xs text-slate-500 mb-2">सहभागिताको प्रकार:</p>
                        <div class="space-y-2">
                             <label class="flex items-center gap-2"><input type="checkbox" name="participation_form" value="Labor" class="accent-indigo-600"> Labor contribution</label>
                             <label class="flex items-center gap-2"><input type="checkbox" name="participation_form" value="Financial" class="accent-indigo-600"> Financial contribution</label>
                             <label class="flex items-center gap-2"><input type="checkbox" name="participation_form" value="Meetings" class="accent-indigo-600"> Meeting attendance</label>
                             <label class="flex items-center gap-2"><input type="checkbox" name="participation_form" value="Committee" class="accent-indigo-600"> Committee role</label>
                             <label class="flex items-center gap-2"><input type="checkbox" name="participation_form" value="Low" class="accent-indigo-600"> Low participation</label>
                        </div>
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-slate-800 mb-2 block">2. Final decision usually taken by:</label>
                        <p class="font-nepali text-xs text-slate-500 mb-2">अन्तिम निर्णय गर्ने निकाय:</p>
                        <select name="decision_maker" class="w-full bg-slate-50 border border-slate-300 rounded-lg px-3 py-2 outline-none">
                            <option value="Local government">Local government</option>
                            <option value="Community leaders">Community leaders</option>
                            <option value="Committee">Committee</option>
                            <option value="External organization">External organization</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-slate-800 mb-2 block">3. Women and youth participation level:</label>
                        <div class="flex gap-2">
                            <label class="option-card px-3 py-2 rounded-lg bg-white cursor-pointer flex-1 text-center"><input type="radio" name="women_youth_part" value="Active" class="hidden"><span class="text-xs font-bold block">Active</span></label>
                            <label class="option-card px-3 py-2 rounded-lg bg-white cursor-pointer flex-1 text-center"><input type="radio" name="women_youth_part" value="Limited" class="hidden"><span class="text-xs font-bold block">Limited</span></label>
                            <label class="option-card px-3 py-2 rounded-lg bg-white cursor-pointer flex-1 text-center"><input type="radio" name="women_youth_part" value="None" class="hidden"><span class="text-xs font-bold block">None</span></label>
                        </div>
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-slate-800 mb-2 block">4. Barriers to participation:</label>
                        <div class="grid grid-cols-2 gap-2">
                            <label class="option-card p-2 rounded bg-white cursor-pointer flex items-center"><input type="checkbox" name="barriers" value="Lack of information" class="mr-2 accent-indigo-600"><span class="text-xs">Lack of information</span></label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer flex items-center"><input type="checkbox" name="barriers" value="Time constraints" class="mr-2 accent-indigo-600"><span class="text-xs">Time constraints</span></label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer flex items-center"><input type="checkbox" name="barriers" value="Social barriers" class="mr-2 accent-indigo-600"><span class="text-xs">Social barriers</span></label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer flex items-center"><input type="checkbox" name="barriers" value="Lack of trust" class="mr-2 accent-indigo-600"><span class="text-xs">Lack of trust</span></label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer flex items-center col-span-2"><input type="checkbox" name="barriers" value="Other" class="mr-2 accent-indigo-600"><span class="text-xs">Other</span></label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION 9 (Suggestions & Observation) -->
            <div class="bg-yellow-50 rounded-2xl shadow-sm border border-yellow-200 overflow-hidden relative">
                <div class="absolute top-0 right-0 bg-yellow-200 text-yellow-800 text-[10px] font-bold px-3 py-1 rounded-bl-xl">STAFF ONLY</div>
                <div class="bg-yellow-100/80 p-4 border-b border-yellow-200 flex items-center gap-3">
                     <div class="w-8 h-8 rounded-lg bg-yellow-300 text-yellow-900 flex items-center justify-center font-bold text-sm">9</div>
                     <div>
                         <h2 class="font-bold text-yellow-900 text-sm uppercase">Suggestions & Observation</h2>
                         <p class="font-nepali text-xs text-yellow-700">खण्ड ९: सुझाव तथा अवलोकन</p>
                     </div>
                </div>
                <div class="p-5 space-y-4">
                     <div>
                         <label class="text-sm font-semibold text-yellow-900 mb-2 block">1. Suggestions for inclusive & participatory development:</label>
                         <p class="font-nepali text-xs text-yellow-700 mb-2">समावेशी विकासका सुझाव:</p>
                         <textarea name="inclusive_suggestions" class="w-full bg-white border border-yellow-300 rounded-lg px-3 py-2 outline-none h-20"></textarea>
                     </div>
                     
                     <hr class="border-yellow-200">
                     
                     <label class="text-xs font-bold text-yellow-900 uppercase mb-2 block">Enumerator Observation (Do not ask):</label>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm text-yellow-900">
                         <label class="flex items-center gap-2"><input type="checkbox" name="obs_leadership" class="accent-yellow-600"> Strong leadership dominance</label>
                         <label class="flex items-center gap-2"><input type="checkbox" name="obs_exclusion" class="accent-yellow-600"> Signs of exclusion</label>
                         <label class="flex items-center gap-2"><input type="checkbox" name="obs_active_presence" class="accent-yellow-600"> Active women/youth presence</label>
                         <label class="flex items-center gap-2"><input type="checkbox" name="obs_separation" class="accent-yellow-600"> Institutional separation</label>
                     </div>
                     <div>
                         <label class="text-xs font-bold text-yellow-900 uppercase mb-1 block">Remarks</label>
                         <input type="text" name="obs_remarks" class="w-full p-2 rounded text-sm border border-yellow-300 outline-none">
                     </div>
                </div>
            </div>
            
            <!-- Shared Meta -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5 mt-6">
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-slate-900 uppercase mb-1 block">Enumerator Name</label>
                        <input type="text" name="enumerator_name" required class="w-full p-2 rounded text-sm border border-slate-300 outline-none focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-900 uppercase mb-1 block">Date</label>
                        <input type="date" name="survey_date" required class="w-full p-2 rounded text-sm border border-slate-300 bg-white outline-none focus:border-indigo-500">
                    </div>
                </div>
                <!-- Signature -->
                <div class="mt-4">
                    <label class="text-xs font-bold text-slate-900 uppercase mb-1 block">Enumerator Signature</label>
                    <div class="border-2 border-dashed border-slate-300 bg-white rounded-xl overflow-hidden relative touch-none">
                        <canvas id="signature-pad" width="300" height="120" class="w-full h-32 cursor-crosshair"></canvas>
                        <button type="button" onclick="clearSignature()" class="absolute top-2 right-2 text-[10px] bg-slate-200 px-2 py-1 rounded hover:bg-slate-300 z-10">Clear</button>
                    </div>
                    <input type="hidden" name="signature_data" id="signature_data">
                </div>
            </div>

            <!-- Footer Buttons -->
            <div class="fixed bottom-0 left-0 right-0 p-4 bg-white/90 backdrop-blur-lg border-t border-slate-200 flex gap-3 max-w-4xl mx-auto z-40 shadow-2xl">
                <button type="button" onclick="if(confirm('Reset form?')) { document.getElementById('mainForm').reset(); clearSignature(); clearDraft(); window.scrollTo(0,0); }" class="px-4 py-3 bg-slate-100 text-slate-600 font-bold rounded-xl hover:bg-slate-200 transition">
                    <i class="fas fa-undo"></i>
                </button>
                <button type="submit" id="submitBtn" class="flex-1 bg-gradient-to-r from-indigo-600 to-blue-600 text-white font-bold text-lg rounded-xl shadow-lg shadow-indigo-200 hover:shadow-indigo-300 transition-all flex items-center justify-center gap-2 py-3">
                    <span>Save Survey Data</span>
                    <i class="fas fa-save"></i>
                </button>
            </div>
        </form>
    </div>

    <!-- DASHBOARD VIEW -->
    <div id="dashboard-view" class="view-section max-w-4xl mx-auto p-4 space-y-6">
        
        <!-- Stats Summary (From App 2) -->
        <div class="grid grid-cols-2 gap-4">
            <div class="bg-gradient-to-br from-indigo-500 to-indigo-700 text-white p-5 rounded-2xl shadow-lg relative overflow-hidden">
                <i class="fas fa-database absolute -bottom-4 -right-4 text-7xl text-white/20"></i>
                <p class="text-indigo-100 text-xs font-bold uppercase tracking-wider">Total Records</p>
                <p id="totalCount" class="text-4xl font-bold mt-1">0</p>
            </div>
            <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm flex flex-col justify-center">
                 <p class="text-xs text-slate-500 font-bold uppercase mb-2">Consent Rate</p>
                 <div class="flex justify-between items-center mb-2">
                     <span class="text-sm">Agreed</span>
                     <span id="statConsent" class="font-bold text-indigo-600">0%</span>
                 </div>
                 <div class="w-full bg-slate-100 rounded-full h-2 overflow-hidden">
                     <div id="progConsent" class="bg-indigo-500 h-2 rounded-full" style="width: 0%"></div>
                 </div>
            </div>
        </div>
        
        <!-- Search Bar (From App 2) -->
        <div class="relative">
            <i class="fas fa-search absolute left-3 top-3 text-slate-400"></i>
            <input type="text" id="searchInput" onkeyup="searchRecords()" placeholder="Search Settlement or Respondent..." class="w-full pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 shadow-sm focus:border-indigo-500 outline-none">
        </div>

        <div>
            <div class="flex justify-between items-end mb-3 px-1">
                <h3 class="font-bold text-slate-800 text-lg">Recent Entries</h3>
                <button onclick="clearAllData()" class="text-[10px] text-red-500 font-bold hover:text-red-700 bg-red-50 px-3 py-1.5 rounded-full uppercase tracking-wide">Delete All</button>
            </div>
            <div id="dashboardList" class="space-y-3 pb-20">
                <!-- Items injected here -->
            </div>
        </div>

        <!-- Float Export Button -->
        <button onclick="exportLocal()" class="fixed bottom-24 right-4 bg-green-600 text-white p-4 rounded-full shadow-xl hover:bg-green-700 active:scale-95 transition z-40 group">
            <i class="fas fa-file-excel text-xl"></i>
            <span class="absolute right-full mr-2 bg-slate-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap">Export Excel</span>
        </button>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[60] flex items-center justify-center p-4 fade-in">
        <div class="bg-white rounded-3xl p-6 w-full max-w-sm text-center shadow-2xl scale-100">
            <div class="w-16 h-16 bg-green-100 text-green-500 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl shadow-inner">
                <i class="fas fa-check"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-900 mb-1">Saved Successfully</h3>
            <p class="text-slate-500 text-sm mb-6" id="successMsg">Data stored on device.</p>
            <div class="space-y-3">
                <button onclick="closeModal()" class="w-full bg-slate-900 text-white font-bold py-3.5 rounded-xl hover:bg-slate-800 transition active:scale-95">Start New Survey</button>
                <button onclick="toggleView(); closeModal();" class="w-full text-slate-600 font-semibold py-2 text-sm hover:text-slate-900">View Dashboard</button>
            </div>
        </div>
    </div>
    
    <!-- Detail View Modal (From App 2) -->
    <div id="detailModal" class="hidden fixed inset-0 bg-white z-[70] overflow-y-auto fade-in">
        <div class="sticky top-0 bg-white border-b border-slate-200 p-4 flex justify-between items-center z-10 shadow-sm">
            <h2 class="font-bold text-lg">Survey Details</h2>
            <button onclick="closeDetailModal()" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 hover:bg-slate-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="detailContent" class="p-5 space-y-4 pb-20 text-sm">
            <!-- Content Injected via JS -->
        </div>
    </div>

    <script>
        const DB_KEY = 'community_perception_v3';
        const DRAFT_KEY = 'community_draft_v3';

        // --- Signature Pad ---
        const canvas = document.getElementById('signature-pad');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;

        function getPos(canvas, evt) {
            const rect = canvas.getBoundingClientRect();
            // Handle both mouse and touch
            const clientX = evt.touches ? evt.touches[0].clientX : evt.clientX;
            const clientY = evt.touches ? evt.touches[0].clientY : evt.clientY;
            
            const scaleX = canvas.width / rect.width; 
            const scaleY = canvas.height / rect.height;
            
            return {
                x: (clientX - rect.left) * scaleX,
                y: (clientY - rect.top) * scaleY
            };
        }

        function startDraw(e) { e.preventDefault(); isDrawing = true; const pos = getPos(canvas, e); ctx.beginPath(); ctx.moveTo(pos.x, pos.y); }
        function draw(e) { if (!isDrawing) return; e.preventDefault(); const pos = getPos(canvas, e); ctx.lineTo(pos.x, pos.y); ctx.stroke(); }
        function endDraw(e) { if(isDrawing) { isDrawing = false; document.getElementById('signature_data').value = "Signed"; saveDraftDebounced(); } }

        canvas.addEventListener('mousedown', startDraw);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', endDraw);
        canvas.addEventListener('touchstart', startDraw, {passive: false});
        canvas.addEventListener('touchmove', draw, {passive: false});
        canvas.addEventListener('touchend', endDraw);

        function clearSignature() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            document.getElementById('signature_data').value = "";
        }

        // --- GPS Logic ---
        let watchId = null;
        let bestAccuracy = Infinity;
        let bestCoords = null;
        let gpsTimeout = null;

        function getGPS() {
            const status = document.getElementById('gps_status');
            const input = document.getElementById('gps_input');
            const btnTrack = document.getElementById('btn_track');
            const btnStop = document.getElementById('btn_stop');
            
            if (watchId) navigator.geolocation.clearWatch(watchId);
            if (gpsTimeout) clearTimeout(gpsTimeout);
            bestAccuracy = Infinity;
            bestCoords = null;
            
            btnTrack.classList.add('hidden');
            btnStop.classList.remove('hidden');
            input.value = "Acquiring...";
            status.innerHTML = '<span class="text-indigo-600"><i class="fas fa-spinner fa-spin"></i> Warming up...</span>';

            if (!navigator.geolocation) { finishGPS(false); status.innerText = "GPS not supported."; return; }

            watchId = navigator.geolocation.watchPosition(
                (pos) => {
                    const acc = pos.coords.accuracy;
                    const lat = pos.coords.latitude.toFixed(6);
                    const lng = pos.coords.longitude.toFixed(6);
                    
                    if (acc < bestAccuracy) {
                        bestAccuracy = acc;
                        bestCoords = `${lat}, ${lng}`;
                        input.value = bestCoords; 
                        saveDraftDebounced(); // Save when GPS updates
                    }
                    let color = bestAccuracy < 15 ? 'text-indigo-500' : 'text-orange-500';
                    if (bestAccuracy <= 5) color = 'text-green-600';
                    status.innerHTML = `<span class="${color} font-mono"><i class="fas fa-crosshairs"></i> Accuracy: <b>${bestAccuracy.toFixed(1)}m</b></span>`;
                    if (bestAccuracy <= 4) finishGPS(true);
                },
                (err) => { if (bestAccuracy === Infinity) { status.innerText = "Error: " + err.message; finishGPS(false); } },
                { enableHighAccuracy: true, timeout: 30000, maximumAge: 0 }
            );

            gpsTimeout = setTimeout(() => { finishGPS(true); }, 30000);
        }

        function finishGPS(saveResult) {
            if (watchId) navigator.geolocation.clearWatch(watchId);
            if (gpsTimeout) clearTimeout(gpsTimeout);
            watchId = null;

            document.getElementById('btn_track').classList.remove('hidden');
            document.getElementById('btn_stop').classList.add('hidden');
            document.getElementById('btn_track').innerHTML = '<i class="fas fa-redo mr-1"></i> GPS';

            if (saveResult && bestCoords) {
                document.getElementById('gps_input').value = bestCoords;
                document.getElementById('gps_status').innerHTML = `<span class="text-green-700 font-bold"><i class="fas fa-check-circle"></i> Locked (${bestAccuracy.toFixed(1)}m)</span>`;
            } else if (!bestCoords) {
                document.getElementById('gps_input').value = "";
                document.getElementById('gps_status').innerText = "Location not found";
            }
            saveDraftDebounced();
        }

        // --- Draft Logic (From App 2) ---
        let saveTimeout;
        function saveDraftDebounced() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveDraft, 1000);
        }

        function saveDraft() {
            const formData = new FormData(document.getElementById('mainForm'));
            const data = {};
            formData.forEach((value, key) => {
                if(!data[key]) {
                    data[key] = value;
                } else {
                    if(!Array.isArray(data[key])){ data[key] = [data[key]]; }
                    data[key].push(value);
                }
            });
            localStorage.setItem(DRAFT_KEY, JSON.stringify(data));
            
            const indicator = document.getElementById('draftStatus');
            indicator.classList.remove('hidden');
            setTimeout(() => indicator.classList.add('hidden'), 2000);
        }

        function checkDraft() {
            const draft = localStorage.getItem(DRAFT_KEY);
            if(draft) {
                document.getElementById('restoreDraftAlert').classList.remove('hidden');
            }
        }

        function restoreDraft() {
            const draft = JSON.parse(localStorage.getItem(DRAFT_KEY));
            if(!draft) return;
            
            const form = document.getElementById('mainForm');
            
            for (const key in draft) {
                const value = draft[key];
                const inputs = form.querySelectorAll(`[name="${key}"]`);
                
                if(inputs.length > 0) {
                    if(inputs[0].type === 'radio') {
                        inputs.forEach(input => {
                            if(input.value === value) input.checked = true;
                        });
                    } else if(inputs[0].type === 'checkbox') {
                         if(Array.isArray(value)) {
                             inputs.forEach(input => {
                                 if(value.includes(input.value)) input.checked = true;
                             });
                         } else {
                             inputs.forEach(input => {
                                 if(input.value === value) input.checked = true;
                             });
                         }
                    } else {
                        inputs[0].value = value;
                    }
                }
            }
            document.getElementById('restoreDraftAlert').classList.add('hidden');
        }

        function clearDraft() {
            localStorage.removeItem(DRAFT_KEY);
            document.getElementById('restoreDraftAlert').classList.add('hidden');
        }

        // --- Form Submission ---
        document.getElementById('mainForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const oldHtml = btn.innerHTML;
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

            try {
                const formData = new FormData(e.target);
                const getMulti = (name) => Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(cb => cb.value).join(', ');

                const data = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    consent: formData.get('consent'),
                    enumerator: formData.get('enumerator_name'),
                    surveyDate: formData.get('survey_date'),
                    gps: formData.get('gps_coords'),
                    signed: formData.get('signature_data') ? 'Yes' : 'No',
                    
                    // S1
                    settlement: formData.get('settlement'),
                    ward: formData.get('ward'),
                    respondent: formData.get('respondent'),
                    gender: formData.get('gender'),
                    age: formData.get('age'),
                    occupation: formData.get('occupation'),
                    yearsLived: formData.get('years_lived'),

                    // S2
                    relationship: formData.get('relationship'),
                    interaction: formData.get('interaction'),
                    sharedFacilities: getMulti('shared_facilities'),

                    // S3
                    priorityNeeds: getMulti('priority_needs'),
                    impact: formData.get('impact'),
                    concerns: formData.get('concerns'),

                    // S4
                    waterShared: formData.get('water_shared'),
                    understandings: formData.get('understandings'),
                    disagreements: formData.get('disagreements'),

                    // S5
                    participation: formData.get('participation'),
                    willingness: formData.get('willingness'),
                    suggestions: formData.get('suggestions'),

                    // S6 (New)
                    local_gov_relation: formData.get('local_gov_relation'),
                    gov_consult: formData.get('gov_consult'),
                    fair_dist: formData.get('fair_dist'),

                    // S7 (New)
                    active_groups: getMulti('active_groups'),
                    inclusive_groups: formData.get('inclusive_groups'),
                    influential_group: formData.get('influential_group'),

                    // S8 (New)
                    participation_form: getMulti('participation_form'),
                    decision_maker: formData.get('decision_maker'),
                    women_youth_part: formData.get('women_youth_part'),
                    barriers: getMulti('barriers'),

                    // S9 (New)
                    inclusive_suggestions: formData.get('inclusive_suggestions'),
                    obs_leadership: formData.get('obs_leadership') ? 'Yes' : 'No',
                    obs_exclusion: formData.get('obs_exclusion') ? 'Yes' : 'No',
                    obs_active_presence: formData.get('obs_active_presence') ? 'Yes' : 'No',
                    obs_separation: formData.get('obs_separation') ? 'Yes' : 'No',
                    obs_remarks: formData.get('obs_remarks')
                };

                const existing = JSON.parse(localStorage.getItem(DB_KEY) || '[]');
                existing.unshift(data);
                localStorage.setItem(DB_KEY, JSON.stringify(existing));

                clearDraft();
                document.getElementById('successModal').classList.remove('hidden');
                
            } catch (err) {
                alert("Error saving: " + err.message);
            } finally {
                btn.disabled = false; btn.innerHTML = oldHtml;
            }
        });

        // --- Navigation ---
        function toggleView() {
            const form = document.getElementById('survey-view');
            const dash = document.getElementById('dashboard-view');
            const btn = document.getElementById('navBtn');
            
            if (form.classList.contains('active')) {
                form.classList.remove('active');
                dash.classList.add('active');
                btn.innerHTML = '<i class="fas fa-pen"></i> Form';
                loadDashboard();
            } else {
                dash.classList.remove('active');
                form.classList.add('active');
                btn.innerHTML = '<i class="fas fa-th-large"></i> Dashboard';
            }
            window.scrollTo(0,0);
        }

        let allData = [];
        function loadDashboard() {
            allData = JSON.parse(localStorage.getItem(DB_KEY) || '[]');
            document.getElementById('totalCount').innerText = allData.length;
            
            // Calculate Stats
            const total = allData.length || 1;
            const consented = allData.filter(d => d.consent === 'Yes').length;
            const conPerc = Math.round((consented / total) * 100);
            document.getElementById('statConsent').innerText = conPerc + "%";
            document.getElementById('progConsent').style.width = conPerc + "%";

            renderList(allData);
        }

        function searchRecords() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allData.filter(d => 
                (d.settlement || '').toLowerCase().includes(term) ||
                (d.respondent || '').toLowerCase().includes(term)
            );
            renderList(filtered);
        }

        function renderList(data) {
            const list = document.getElementById('dashboardList');
            if(data.length === 0) {
                list.innerHTML = '<div class="text-center py-10 text-slate-400 border border-dashed rounded-lg">No surveys found</div>';
                return;
            }

            list.innerHTML = data.map(d => `
                <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm relative overflow-hidden">
                    <div class="absolute left-0 top-0 bottom-0 w-1 bg-indigo-500"></div>
                    <div class="flex justify-between items-start pl-3">
                        <div>
                            <h4 class="font-bold text-slate-800">${d.settlement || 'Unknown Area'}</h4>
                            <p class="text-xs text-slate-500 font-mono mt-1"><i class="far fa-clock"></i> ${new Date(d.timestamp).toLocaleDateString()}</p>
                            <p class="text-xs text-indigo-600 mt-1">Resp: ${d.respondent || 'N/A'}</p>
                        </div>
                        <button onclick="viewDetail(${d.id})" class="text-xs bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded-lg font-bold hover:bg-indigo-100">
                            View
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function viewDetail(id) {
            const record = allData.find(d => d.id === id);
            if(!record) return;
            
            const content = document.getElementById('detailContent');
            let html = '';
            for (const [key, value] of Object.entries(record)) {
                if(value && key !== 'id') {
                     html += `
                        <div class="border-b border-slate-100 pb-2 last:border-0">
                            <span class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">${key.replace(/_/g, ' ')}</span>
                            <span class="block text-slate-800 font-medium">${value}</span>
                        </div>
                     `;
                }
            }
            content.innerHTML = html;
            document.getElementById('detailModal').classList.remove('hidden');
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.add('hidden');
        }

        function exportLocal() {
            const rawData = JSON.parse(localStorage.getItem(DB_KEY) || '[]');
            if(!rawData.length) { alert("No data to export"); return; }
            
            // Map data headers
            const exportData = rawData.map(item => ({
                "ID": item.id,
                "Date": new Date(item.timestamp).toLocaleString(),
                "Consent": item.consent,
                "Enumerator": item.enumerator,
                "GPS": item.gps,
                "Settlement": item.settlement,
                "Ward": item.ward,
                "Respondent": item.respondent,
                "Gender": item.gender,
                "Age": item.age,
                "Relationship": item.relationship,
                "Interaction": item.interaction,
                "Shared Facilities": item.sharedFacilities,
                "Priority Needs": item.priorityNeeds,
                "Impact": item.impact,
                "Concerns": item.concerns,
                "Water Shared": item.waterShared,
                "Understandings": item.understandings,
                "Disagreements": item.disagreements,
                "Participation": item.participation,
                "Willingness": item.willingness,
                "Suggestions": item.suggestions,
                // New Fields
                "Local Gov Relation": item.local_gov_relation,
                "Gov Consult": item.gov_consult,
                "Fair Distribution": item.fair_dist,
                "Active Groups": item.active_groups,
                "Inclusive Groups": item.inclusive_groups,
                "Influential Group": item.influential_group,
                "Part. Forms": item.participation_form,
                "Decision Maker": item.decision_maker,
                "Women/Youth Part": item.women_youth_part,
                "Barriers": item.barriers,
                "Inclusive Sugg": item.inclusive_suggestions,
                "Obs: Leadership": item.obs_leadership,
                "Obs: Exclusion": item.obs_exclusion,
                "Obs: Active Pres": item.obs_active_presence,
                "Obs: Separation": item.obs_separation,
                "Obs: Remarks": item.obs_remarks
            }));

            // Workbook
            const wb = XLSX.utils.book_new();

            // Data Sheet
            const ws = XLSX.utils.json_to_sheet(exportData);
            
            // Auto-width
            const wscols = Object.keys(exportData[0]).map(() => ({wch: 25}));
            ws['!cols'] = wscols;
            XLSX.utils.book_append_sheet(wb, ws, "Survey Data");

            // Summary Sheet
            const summaryData = [
                ["SUMMARY REPORT", ""],
                ["Generated On", new Date().toLocaleString()],
                ["Total Surveys", rawData.length],
                ["Consent Given", rawData.filter(d => d.consent === 'Yes').length]
            ];
            const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, wsSummary, "Summary");
            
            const dateStr = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `Community_Survey_${dateStr}.xlsx`);
        }

        function clearAllData() {
            if(confirm("Are you sure you want to delete ALL survey records? This cannot be undone.")) {
                localStorage.removeItem(DB_KEY);
                loadDashboard();
            }
        }
        
        function closeModal() {
            document.getElementById('successModal').classList.add('hidden');
            document.getElementById('mainForm').reset();
            clearSignature();
            document.querySelector('input[name="survey_date"]').valueAsDate = new Date();
            window.scrollTo(0,0);
        }
        
        function updateProgress() {
            const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
            const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
            const scrolled = (winScroll / height) * 100;
            document.getElementById("progress-bar").style.width = scrolled + "%";
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelector('input[name="survey_date"]').valueAsDate = new Date();
            checkDraft();
        });
    </script>
</body>
</html>
