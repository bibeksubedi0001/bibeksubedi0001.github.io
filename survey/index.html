<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Household Sanitation & Living Conditions Survey</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SheetJS for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                        nepali: ['"Noto Sans Devanagari"', 'sans-serif'],
                    },
                    colors: {
                        brand: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 900: '#0c4a6e' }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f1f5f9; -webkit-tap-highlight-color: transparent; }
        html { scroll-behavior: smooth; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .option-card {
            transition: all 0.2s;
            border: 1px solid #e2e8f0;
            position: relative;
            overflow: hidden;
        }
        .option-card:active { transform: scale(0.97); background-color: #f8fafc; }
        
        .option-card:has(input:checked) {
            border-color: #0284c7;
            background-color: #f0f9ff;
            box-shadow: 0 4px 6px -1px rgba(2, 132, 199, 0.1);
        }
        .option-card:has(input:checked)::after {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 4px; right: 4px;
            color: #0284c7;
            font-size: 12px;
        }

        /* Valid Input Styling */
        input:not([type="checkbox"]):not([type="radio"]):valid:not(:placeholder-shown),
        select:valid:not([value=""]) {
            border-color: #10b981; /* Green border when filled */
            background-color: #f0fdf4;
        }

        .glass-header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .section-badge {
            background: linear-gradient(135deg, #0284c7, #0ea5e9);
            color: white;
            box-shadow: 0 2px 4px rgba(14, 165, 233, 0.3);
        }

        /* Table Styling for Education Matrix */
        .edu-table th, .edu-table td {
            border: 1px solid #e2e8f0;
            padding: 8px;
            text-align: center;
        }
        .edu-table th {
            background-color: #f8fafc;
            font-size: 0.75rem;
            font-weight: 700;
            color: #475569;
        }

        canvas { touch-action: none; background: #fff; background-image: radial-gradient(#e2e8f0 1px, transparent 1px); background-size: 20px 20px; }
        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.3s ease-out; }
        #progress-bar { transition: width 0.3s ease; }
    </style>
</head>
<body class="pb-32 text-slate-800 antialiased" onscroll="updateProgress()">

    <!-- Header -->
    <header class="glass-header fixed top-0 left-0 right-0 z-50">
        <div class="h-1 bg-slate-200 w-full">
            <div id="progress-bar" class="h-full bg-blue-600 w-0"></div>
        </div>
        <div class="flex justify-between items-center max-w-4xl mx-auto p-3 px-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-blue-50 text-blue-600 flex items-center justify-center text-lg shadow-sm">
                    <i class="fas fa-clipboard-check"></i>
                </div>
                <div class="leading-tight">
                    <h1 class="text-xs font-bold text-slate-900 uppercase tracking-wide">Sanitation Survey</h1>
                    <p class="text-[10px] text-slate-500 font-nepali">घरधुरी सरसफाइ तथा जीवनस्तर सर्वेक्षण</p>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <!-- Draft Status Indicator -->
                <span id="draftStatus" class="hidden text-[10px] bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full font-bold animate-pulse">
                    <i class="fas fa-save mr-1"></i> Draft Saved
                </span>

                <button onclick="toggleView()" id="navBtn" class="bg-slate-900 text-white px-4 py-2 rounded-lg text-xs font-bold transition active:scale-95 shadow-lg flex items-center gap-2">
                    <i class="fas fa-th-large"></i> Dashboard
                </button>
            </div>
        </div>
    </header>

    <div class="h-20"></div>

    <!-- SURVEY FORM -->
    <div id="survey-view" class="view-section active">
        <!-- Draft Restore Alert -->
        <div id="restoreDraftAlert" class="hidden max-w-4xl mx-auto px-4 mb-4">
            <div class="bg-blue-50 border border-blue-200 p-4 rounded-xl flex items-center justify-between">
                <div>
                    <p class="text-sm font-bold text-blue-800">Unsaved draft found!</p>
                    <p class="text-xs text-blue-600">Do you want to restore your previous session?</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="clearDraft()" class="text-xs text-slate-500 hover:text-slate-800 px-3 py-2">Discard</button>
                    <button onclick="restoreDraft()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-xs font-bold shadow hover:bg-blue-700">Restore</button>
                </div>
            </div>
        </div>

        <form id="surveyForm" class="max-w-4xl mx-auto p-4 space-y-6" oninput="saveDraftDebounced()">
            
            <!-- CONSENT SECTION (NEW) -->
            <div class="bg-indigo-50 rounded-2xl shadow-sm border border-indigo-100 overflow-hidden">
                <div class="p-5">
                    <h2 class="font-bold text-indigo-900 text-sm uppercase mb-1"><i class="fas fa-handshake mr-2"></i>Informed Consent / मञ्जुरीनामा</h2>
                    <div class="text-xs text-slate-600 space-y-2 mb-4 leading-relaxed text-justify bg-white p-3 rounded border border-indigo-100">
                        <p>We are conducting a survey to understand the sanitation practices, water access, and overall living conditions in your community. The information collected will be used to help design better sanitation facilities and community development programs.</p>
                        <p class="font-nepali text-slate-500">हामी तपाईंको समुदायमा सरसफाइको अवस्था, पानीको पहुँच र समग्र जीवनस्तर बुझ्नको लागि यो सर्वेक्षण गर्दैछौं। यसबाट प्राप्त जानकारीलाई समुदायमा राम्रो शौचालय निर्माण र विकास योजनाहरू बनाउन प्रयोग गरिनेछ।</p>
                        <p>Your participation is completely voluntary. The survey will take about 15-20 minutes. All information you provide will be kept strictly confidential. You can choose not to answer any specific question or stop the interview at any time.</p>
                        <p class="font-nepali text-slate-500">यसमा तपाईंको सहभागिता पूर्ण रूपमा स्वैच्छिक हो। यो सर्वेक्षणमा लगभग १५-२० मिनेट लाग्नेछ। तपाईंले दिनुभएको सबै जानकारी पूर्ण रूपमा गोप्य राखिनेछ। तपाईंले कुनै पनि प्रश्नको उत्तर नदिन वा जुनसुकै बेला अन्तर्वार्ता रोक्न सक्नुहुन्छ।</p>
                    </div>

                    <label class="text-xs font-bold text-slate-700 uppercase mb-2 block">Do you agree to participate? / के तपाईं सहभागी हुन सहमत हुनुहुन्छ?</label>
                    <div class="flex flex-col gap-2">
                        <label class="option-card px-4 py-3 rounded-lg bg-white cursor-pointer flex items-center gap-3">
                            <input type="radio" name="consent" value="Yes" required class="accent-indigo-600">
                            <div>
                                <span class="text-sm font-bold block">Yes, the respondent agrees</span>
                                <span class="text-[10px] text-slate-500 font-nepali">हो, उत्तरदाता सहभागी हुन सहमत हुनुहुन्छ</span>
                            </div>
                        </label>
                        <label class="option-card px-4 py-3 rounded-lg bg-white cursor-pointer flex items-center gap-3">
                            <input type="radio" name="consent" value="No" class="accent-red-600">
                            <div>
                                <span class="text-sm font-bold block text-red-600">No, the respondent declined</span>
                                <span class="text-[10px] text-slate-500 font-nepali">होइन, उत्तरदाताले अस्वीकार गर्नुभयो</span>
                            </div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- SECTION 1 -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="bg-slate-50 p-4 border-b border-slate-100 flex items-center gap-3">
                    <div class="section-badge w-8 h-8 rounded-lg flex items-center justify-center font-bold text-sm">1</div>
                    <div>
                        <h2 class="font-bold text-slate-800 text-sm uppercase">Basic Information</h2>
                        <p class="font-nepali text-xs text-slate-500">खण्ड १: आधारभूत जानकारी</p>
                    </div>
                </div>
                <div class="p-5 space-y-4">
                    <!-- Q1 -->
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-1 block">1. Respondent Name / उत्तरदाताको नाम (Optional)</label>
                        <input type="text" name="respondent_name" class="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 focus:border-blue-500 outline-none">
                    </div>
                    <!-- Q2 & Q3 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-bold text-slate-600 uppercase mb-1 block">2. Settlement / Tole / बस्ती / टोल</label>
                            <input type="text" name="settlement" required class="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 focus:border-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-600 uppercase mb-1 block">3. House Number / घर नं</label>
                            <input type="text" name="house_number" class="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 focus:border-blue-500 outline-none">
                        </div>
                    </div>
                    <!-- Q4 -->
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">4. Gender / लिङ्ग</label>
                        <div class="flex gap-2">
                            <label class="option-card px-4 py-2 rounded-lg bg-white cursor-pointer flex-1 text-center"><input type="radio" name="gender" value="Male" class="hidden"><span class="text-sm font-bold">Male (पुरुष)</span></label>
                            <label class="option-card px-4 py-2 rounded-lg bg-white cursor-pointer flex-1 text-center"><input type="radio" name="gender" value="Female" class="hidden"><span class="text-sm font-bold">Female (महिला)</span></label>
                            <label class="option-card px-4 py-2 rounded-lg bg-white cursor-pointer flex-1 text-center"><input type="radio" name="gender" value="Other" class="hidden"><span class="text-sm font-bold">Other (अन्य)</span></label>
                        </div>
                    </div>
                    <!-- Q5, Q6 -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-bold text-slate-600 uppercase mb-1 block">5. Age / उमेर</label>
                            <input type="number" name="age" class="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 outline-none">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-600 uppercase mb-1 block">6. Religion / धर्म</label>
                            <input type="text" name="religion" class="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 outline-none">
                        </div>
                    </div>
                    <!-- Q7 -->
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">7. Marital Status / वैवाहिक अवस्था</label>
                        <select name="marital_status" class="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 outline-none">
                            <option value="">Select...</option>
                            <option value="Single">Single (अविवाहित)</option>
                            <option value="Married">Married (विवाहित)</option>
                            <option value="Divorced">Divorced (सम्बन्ध विच्छेद)</option>
                            <option value="Widowed">Widowed (विधवा/विधुर)</option>
                            <option value="Separated">Separated (अलग बसेको)</option>
                        </select>
                    </div>
                    <!-- Q8 -->
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-1 block">8. Caste/Ethnic Group / जाति/समुदाय</label>
                        <input type="text" name="caste" class="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 outline-none">
                    </div>
                    <!-- Q9 GPS -->
                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                        <label class="text-xs font-bold text-blue-800 uppercase mb-1 block">9. GPS Coordinates</label>
                        <div class="flex gap-2">
                            <input type="text" id="gps_input" name="gps_coords" readonly class="flex-1 bg-white border border-blue-200 rounded px-2 py-1 text-xs font-mono" placeholder="Lat, Long">
                            <button type="button" id="btn_track" onclick="getGPS()" class="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold shadow-sm hover:bg-blue-700">
                                <i class="fas fa-satellite-dish mr-1"></i> Start GPS
                            </button>
                            <button type="button" id="btn_stop" onclick="finishGPS(true)" class="hidden bg-red-500 text-white px-3 py-1 rounded text-xs font-bold shadow-sm hover:bg-red-600 animate-pulse">
                                <i class="fas fa-stop-circle mr-1"></i> Lock Position
                            </button>
                        </div>
                        <div id="gps_status" class="text-[10px] mt-1 text-slate-500 min-h-[1.5em]"></div>
                    </div>
                </div>
            </div>

            <!-- SECTION 2 -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="bg-slate-50 p-4 border-b border-slate-100 flex items-center gap-3">
                    <div class="section-badge w-8 h-8 rounded-lg flex items-center justify-center font-bold text-sm">2</div>
                    <div>
                        <h2 class="font-bold text-slate-800 text-sm uppercase">Household Composition</h2>
                        <p class="font-nepali text-xs text-slate-500">खण्ड २: परिवारको विवरण</p>
                    </div>
                </div>
                <div class="p-5 space-y-4">
                    <!-- Q10 -->
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-1 block">10. Total Members / कुल सदस्य</label>
                        <input type="number" name="total_members" class="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 font-bold text-lg" placeholder="0">
                    </div>
                    <!-- Q11 NEW: Leading Member -->
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">11. Leading Member / प्रमुख सदस्य</label>
                        <div class="flex gap-2">
                            <label class="option-card px-4 py-2 rounded-lg bg-white cursor-pointer flex-1 text-center"><input type="radio" name="leading_member" value="Male" class="hidden"><span class="text-sm font-bold">Male (पुरुष)</span></label>
                            <label class="option-card px-4 py-2 rounded-lg bg-white cursor-pointer flex-1 text-center"><input type="radio" name="leading_member" value="Female" class="hidden"><span class="text-sm font-bold">Female (महिला)</span></label>
                        </div>
                    </div>
                    
                    <!-- Q12 (Previously 12, kept as requested structure) -->
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">12. Family Type / प्रकार</label>
                        <div class="flex gap-2">
                            <label class="option-card px-4 py-2 rounded-lg bg-white cursor-pointer flex-1 text-center"><input type="radio" name="family_type" value="Nuclear" class="hidden"><span class="text-sm font-bold">Nuclear (एकल)</span></label>
                            <label class="option-card px-4 py-2 rounded-lg bg-white cursor-pointer flex-1 text-center"><input type="radio" name="family_type" value="Joint" class="hidden"><span class="text-sm font-bold">Joint (संयुक्त)</span></label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION 3 -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="bg-slate-50 p-4 border-b border-slate-100 flex items-center gap-3">
                    <div class="section-badge w-8 h-8 rounded-lg flex items-center justify-center font-bold text-sm">3</div>
                    <div>
                        <h2 class="font-bold text-slate-800 text-sm uppercase">Socio-Economic</h2>
                        <p class="font-nepali text-xs text-slate-500">खण्ड ३: सामाजिक–आर्थिक</p>
                    </div>
                </div>
                <div class="p-5 space-y-4">
                    <!-- Q13 -->
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">13. Main Income Sources (Multiple)</label>
                        <div class="grid grid-cols-2 gap-2">
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="checkbox" name="income_source" value="Government Employed" class="mr-2">Gov Employed (सरकारी)</label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="checkbox" name="income_source" value="Private Employed" class="mr-2">Private Job (निजी)</label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="checkbox" name="income_source" value="Business" class="mr-2">Business (व्यवसाय)</label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="checkbox" name="income_source" value="Farming" class="mr-2">Farming (खेती)</label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="checkbox" name="income_source" value="Daily Wage" class="mr-2">Daily Wage (ज्याला)</label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="checkbox" name="income_source" value="Remittance" class="mr-2">Remittance (वैदेशिक)</label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="checkbox" name="income_source" value="Allowance/Pension" class="mr-2">Pension/Allowance (भत्ता)</label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="checkbox" name="income_source" value="Informal work" class="mr-2">Informal (अनौपचारिक)</label>
                        </div>
                        <input type="text" name="income_other" class="mt-2 w-full border border-slate-300 rounded p-2 text-sm" placeholder="Other income...">
                    </div>
                    <!-- Q14 Updated Ranges -->
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">14. Monthly Income / मासिक आम्दानी</label>
                        <select name="monthly_income" class="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 outline-none">
                            <option value="<5000">Below 5,000</option>
                            <option value="5000-10000">5,000 - 10,000</option>
                            <option value="11000-15000">11,000 - 15,000</option>
                            <option value="16000-20000">16,000 - 20,000</option>
                            <option value="21000-30000">21,000 - 30,000</option>
                            <option value=">30000">Above 30,000</option>
                        </select>
                    </div>
                    <!-- Q15 Education Matrix -->
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">15. Education Level / शिक्षा</label>
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse edu-table text-sm">
                                <thead>
                                    <tr>
                                        <th class="text-left bg-slate-100">Level (तह)</th>
                                        <th>Children<br>(0-14)</th>
                                        <th>Adults<br>(15-59)</th>
                                        <th>Elderly<br>(60+)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="text-left text-xs">No formal (औपचारिक छैन)</td>
                                        <td><input type="number" name="edu_no_child" class="w-12 p-1 border rounded text-center" placeholder="0"></td>
                                        <td><input type="number" name="edu_no_adult" class="w-12 p-1 border rounded text-center" placeholder="0"></td>
                                        <td><input type="number" name="edu_no_elder" class="w-12 p-1 border rounded text-center" placeholder="0"></td>
                                    </tr>
                                    <tr>
                                        <td class="text-left text-xs">Primary (प्राथमिक)</td>
                                        <td><input type="number" name="edu_pri_child" class="w-12 p-1 border rounded text-center" placeholder="0"></td>
                                        <td><input type="number" name="edu_pri_adult" class="w-12 p-1 border rounded text-center" placeholder="0"></td>
                                        <td><input type="number" name="edu_pri_elder" class="w-12 p-1 border rounded text-center" placeholder="0"></td>
                                    </tr>
                                    <tr>
                                        <td class="text-left text-xs">Lower Sec (निम्न मा.)</td>
                                        <td><input type="number" name="edu_low_child" class="w-12 p-1 border rounded text-center" placeholder="0"></td>
                                        <td><input type="number" name="edu_low_adult" class="w-12 p-1 border rounded text-center" placeholder="0"></td>
                                        <td><input type="number" name="edu_low_elder" class="w-12 p-1 border rounded text-center" placeholder="0"></td>
                                    </tr>
                                    <tr>
                                        <td class="text-left text-xs">Secondary (माध्यमिक)</td>
                                        <td><input type="number" name="edu_sec_child" class="w-12 p-1 border rounded text-center" placeholder="0"></td>
                                        <td><input type="number" name="edu_sec_adult" class="w-12 p-1 border rounded text-center" placeholder="0"></td>
                                        <td><input type="number" name="edu_sec_elder" class="w-12 p-1 border rounded text-center" placeholder="0"></td>
                                    </tr>
                                    <tr>
                                        <td class="text-left text-xs">Higher Sec (उच्च मा.)</td>
                                        <td><input type="number" name="edu_high_child" class="w-12 p-1 border rounded text-center" placeholder="0"></td>
                                        <td><input type="number" name="edu_high_adult" class="w-12 p-1 border rounded text-center" placeholder="0"></td>
                                        <td><input type="number" name="edu_high_elder" class="w-12 p-1 border rounded text-center" placeholder="0"></td>
                                    </tr>
                                    <tr>
                                        <td class="text-left text-xs">Bachelor+ (स्नातक+)</td>
                                        <td><input type="number" name="edu_bach_child" class="w-12 p-1 border rounded text-center" placeholder="0"></td>
                                        <td><input type="number" name="edu_bach_adult" class="w-12 p-1 border rounded text-center" placeholder="0"></td>
                                        <td><input type="number" name="edu_bach_elder" class="w-12 p-1 border rounded text-center" placeholder="0"></td>
                                    </tr>
                                    <tr>
                                        <td class="text-left text-xs font-bold">Total (जम्मा)</td>
                                        <td><input type="number" name="edu_tot_child" class="w-12 p-1 bg-slate-50 border rounded text-center font-bold"></td>
                                        <td><input type="number" name="edu_tot_adult" class="w-12 p-1 bg-slate-50 border rounded text-center font-bold"></td>
                                        <td><input type="number" name="edu_tot_elder" class="w-12 p-1 bg-slate-50 border rounded text-center font-bold"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Q16 -->
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">16. Migration / बसाइँसराइ</label>
                        <div class="space-y-1">
                            <label class="option-card p-2 rounded bg-white cursor-pointer flex items-center"><input type="radio" name="migration" value="Native" class="mr-2"> Native to this area (स्थानीय)</label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer flex items-center"><input type="radio" name="migration" value="From District" class="mr-2"> Migrated from another district</label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer flex items-center"><input type="radio" name="migration" value="From Abroad" class="mr-2"> Migrated from another country</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION 4 -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="bg-slate-50 p-4 border-b border-slate-100 flex items-center gap-3">
                    <div class="section-badge w-8 h-8 rounded-lg flex items-center justify-center font-bold text-sm">4</div>
                    <div>
                        <h2 class="font-bold text-slate-800 text-sm uppercase">Food Security</h2>
                        <p class="font-nepali text-xs text-slate-500">खण्ड ४: खाद्य सुरक्षा</p>
                    </div>
                </div>
                <div class="p-5">
                    <!-- Q17 -->
                    <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">17. Food Availability (Last Year)</label>
                    <select name="food_security" class="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 outline-none">
                        <option value="12m">Enough for 12 months (१२ महिना पुग्ने)</option>
                        <option value="10-12m">10–12 months (१०–१२ महिना)</option>
                        <option value="7-9m">7–9 months (७–९ महिना)</option>
                        <option value="3-6m">3–6 months (३–६ महिना)</option>
                        <option value="<3m">Less than 3 months (३ महिना भन्दा कम)</option>
                    </select>
                </div>
            </div>

            <!-- SECTION 5 -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="bg-slate-50 p-4 border-b border-slate-100 flex items-center gap-3">
                    <div class="section-badge w-8 h-8 rounded-lg flex items-center justify-center font-bold text-sm">5</div>
                    <div>
                        <h2 class="font-bold text-slate-800 text-sm uppercase">Housing Condition</h2>
                        <p class="font-nepali text-xs text-slate-500">खण्ड ५: आवास अवस्था</p>
                    </div>
                </div>
                <div class="p-5 space-y-4">
                    <!-- Q18 -->
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">18. Construction Material / सामग्री</label>
                        <div class="grid grid-cols-2 gap-2">
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="radio" name="house_material" value="Mud" class="mr-2">Mud/माटो</label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="radio" name="house_material" value="Bamboo" class="mr-2">Bamboo/बाँस</label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="radio" name="house_material" value="Wood" class="mr-2">Wood/काठ</label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="radio" name="house_material" value="CGI" class="mr-2">CGI/टिन</label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="radio" name="house_material" value="Stone" class="mr-2">Stone/ढुंगा</label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="radio" name="house_material" value="Brick" class="mr-2">Brick/Cement</label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="radio" name="house_material" value="Mixed" class="mr-2">Mixed</label>
                        </div>
                        <input type="text" name="material_other" class="mt-2 w-full border border-slate-300 rounded p-2 text-sm" placeholder="Other...">
                    </div>
                    <!-- Q19 -->
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">19. Land Ownership / जग्गा</label>
                        <select name="land_ownership" class="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 outline-none">
                            <option value="Own">Own land (आफ्नो)</option>
                            <option value="Rented">Rented (भाडामा)</option>
                            <option value="Others">Living on others' land (अरूको)</option>
                            <option value="No Legal">No legal ownership</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- SECTION 6 -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="bg-slate-50 p-4 border-b border-slate-100 flex items-center gap-3">
                    <div class="section-badge w-8 h-8 rounded-lg flex items-center justify-center font-bold text-sm">6</div>
                    <div>
                        <h2 class="font-bold text-slate-800 text-sm uppercase">Water Access</h2>
                        <p class="font-nepali text-xs text-slate-500">खण्ड ६: पानीको पहुँच</p>
                    </div>
                </div>
                <div class="p-5 space-y-4">
                    <!-- Q20 -->
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">20. Main Water Source / स्रोत</label>
                        <div class="grid grid-cols-2 gap-2">
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="radio" name="water_source" value="Tap" class="mr-2">Tap/धारा</label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="radio" name="water_source" value="Handpump" class="mr-2">Handpump</label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="radio" name="water_source" value="Well" class="mr-2">Well/इनार</label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="radio" name="water_source" value="Spring" class="mr-2">Spring/मुहान</label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="radio" name="water_source" value="River" class="mr-2">River/नदी</label>
                        </div>
                        <input type="text" name="water_source_other" class="mt-2 w-full border border-slate-300 rounded p-2 text-sm" placeholder="Other...">
                    </div>
                    <!-- Q21 -->
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">21. Availability / उपलब्धता</label>
                        <div class="flex gap-2">
                            <label class="option-card px-4 py-2 rounded-lg bg-white cursor-pointer flex-1"><input type="radio" name="water_avail" value="Year-round" class="mr-2">Year-round</label>
                            <label class="option-card px-4 py-2 rounded-lg bg-white cursor-pointer flex-1"><input type="radio" name="water_avail" value="Seasonal" class="mr-2">Seasonal</label>
                        </div>
                    </div>
                    <!-- Q22 -->
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">22. Distance / दूरी</label>
                        <select name="water_dist" class="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 outline-none">
                            <option value="Compound">Within compound (घरभित्र)</option>
                            <option value="<5min">< 5 minutes</option>
                            <option value=">5min">> 5 minutes</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- SECTION 7 -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="bg-slate-50 p-4 border-b border-slate-100 flex items-center gap-3">
                    <div class="section-badge w-8 h-8 rounded-lg flex items-center justify-center font-bold text-sm">7</div>
                    <div>
                        <h2 class="font-bold text-slate-800 text-sm uppercase">Sanitation Practices</h2>
                        <p class="font-nepali text-xs text-slate-500">खण्ड ७: शौचालय प्रयोग</p>
                    </div>
                </div>
                <div class="p-5 space-y-4">
                    <!-- Q23 -->
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">23. Current Practice / हालको बानी</label>
                        <div class="grid grid-cols-1 gap-2">
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="radio" name="toilet_practice" value="Open Field" class="mr-2"> Open field (खुला ठाउँ)</label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="radio" name="toilet_practice" value="Jungle" class="mr-2"> Jungle (जंगल)</label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="radio" name="toilet_practice" value="Shared Toilet" class="mr-2"> Shared toilet (साझा शौचालय)</label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="radio" name="toilet_practice" value="Own Toilet" class="mr-2"> Own toilet (आफ्नै शौचालय)</label>
                        </div>
                        <input type="text" name="practice_other" class="mt-2 w-full border border-slate-300 rounded p-2 text-sm" placeholder="Other...">
                    </div>
                    <!-- Q24 -->
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">24. Women/Girls Challenges?</label>
                        <div class="flex flex-wrap gap-4 mb-2">
                            <label class="cursor-pointer"><input type="radio" name="women_challenges" value="Yes" class="mr-1"> Yes</label>
                            <label class="cursor-pointer"><input type="radio" name="women_challenges" value="No" class="mr-1"> No</label>
                            <label class="cursor-pointer"><input type="radio" name="women_challenges" value="Sometimes" class="mr-1"> Sometimes</label>
                            <label class="cursor-pointer"><input type="radio" name="women_challenges" value="Dont Know" class="mr-1"> Don't Know</label>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2 p-3 bg-slate-50 rounded border border-slate-200">
                            <p class="col-span-full text-xs text-slate-500 font-bold">If Yes, what type? (Select all that apply)</p>
                            <label class="flex items-center gap-2 text-xs"><input type="checkbox" name="wc_type" value="Privacy"> Lack of privacy</label>
                            <label class="flex items-center gap-2 text-xs"><input type="checkbox" name="wc_type" value="Unsafe"> Unsafe location</label>
                            <label class="flex items-center gap-2 text-xs"><input type="checkbox" name="wc_type" value="No Separate"> No separate toilet</label>
                            <label class="flex items-center gap-2 text-xs"><input type="checkbox" name="wc_type" value="Lighting"> Poor lighting</label>
                            <label class="flex items-center gap-2 text-xs"><input type="checkbox" name="wc_type" value="Water"> Water shortage</label>
                            <label class="flex items-center gap-2 text-xs"><input type="checkbox" name="wc_type" value="Distance"> Distance too far</label>
                            <label class="flex items-center gap-2 text-xs"><input type="checkbox" name="wc_type" value="Menstrual"> Menstrual hygiene</label>
                            <label class="flex items-center gap-2 text-xs"><input type="checkbox" name="wc_type" value="Cleanliness"> Poor cleanliness</label>
                            <label class="flex items-center gap-2 text-xs"><input type="checkbox" name="wc_type" value="Disability"> Disability access</label>
                            <label class="flex items-center gap-2 text-xs"><input type="text" name="wc_other" placeholder="Other..." class="border rounded p-1 w-full"></label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION 8 -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="bg-slate-50 p-4 border-b border-slate-100 flex items-center gap-3">
                    <div class="section-badge w-8 h-8 rounded-lg flex items-center justify-center font-bold text-sm">8</div>
                    <div>
                        <h2 class="font-bold text-slate-800 text-sm uppercase">Living Challenges</h2>
                        <p class="font-nepali text-xs text-slate-500">खण्ड ८: मुख्य समस्याहरू</p>
                    </div>
                </div>
                <div class="p-5 space-y-4">
                    <!-- Q25 -->
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">25. Select Top 5 Challenges (Max 5)</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="checkbox" name="challenges" value="Lack of toilet" class="mr-2">1. Lack of toilet (शौचालय अभाव)</label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="checkbox" name="challenges" value="Water shortage" class="mr-2">2. Water shortage (पानी अभाव)</label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="checkbox" name="challenges" value="Poverty" class="mr-2">3. Poverty (गरिबी)</label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="checkbox" name="challenges" value="Health problems" class="mr-2">4. Health problems (स्वास्थ्य समस्या)</label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="checkbox" name="challenges" value="Education access" class="mr-2">5. Education access (शिक्षा पहुँच)</label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="checkbox" name="challenges" value="Unemployment" class="mr-2">6. Unemployment (बेरोजगारी)</label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="checkbox" name="challenges" value="Landslide/DRR" class="mr-2">7. Landslide/DRR (पहिरो)</label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="checkbox" name="challenges" value="Food insecurity" class="mr-2">8. Food insecurity (खाद्य असुरक्षा)</label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="checkbox" name="challenges" value="Poor road" class="mr-2">9. Poor road (सडक कमजोर)</label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="checkbox" name="challenges" value="Lack of electricity" class="mr-2">10. Lack of electricity (बिजुली अभाव)</label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="checkbox" name="challenges" value="Poor housing" class="mr-2">11. Poor housing (घर कमजोर)</label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="checkbox" name="challenges" value="Gender inequality" class="mr-2">12. Gender inequality (लैङ्गिक असमानता)</label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="checkbox" name="challenges" value="Social discrimination" class="mr-2">13. Social discrimination (विभेद)</label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="checkbox" name="challenges" value="Domestic violence" class="mr-2">14. Domestic violence (घरेलु हिंसा)</label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="checkbox" name="challenges" value="Lack of livelihood" class="mr-2">15. Lack of livelihood (आजीविका कमी)</label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="checkbox" name="challenges" value="Migration issues" class="mr-2">16. Migration issues (बसाइँसराइ)</label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="checkbox" name="challenges" value="Lack of health services" class="mr-2">17. Lack of health services (सेवा अभाव)</label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="checkbox" name="challenges" value="Poor sanitation" class="mr-2">18. Poor sanitation (फोहोर व्यवस्थापन)</label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="checkbox" name="challenges" value="Climate change" class="mr-2">19. Climate change (जलवायु परिवर्तन)</label>
                            <label class="option-card p-2 rounded bg-white cursor-pointer"><input type="checkbox" name="challenges" value="Other" class="mr-2">20. Other (अन्य)</label>
                        </div>
                        <input type="text" name="challenge_other" class="mt-2 w-full border border-slate-300 rounded p-2 text-sm" placeholder="If Other, specify...">
                    </div>
                    <!-- Q26 -->
                    <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                        <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">26. Rank Priorities (1st = Most Serious)</label>
                        <div class="space-y-2">
                            <div class="flex items-center gap-2"><span class="text-sm font-bold w-8">1st</span><input type="text" name="rank_1" class="flex-1 border border-slate-300 rounded p-1" placeholder="Problem 1"></div>
                            <div class="flex items-center gap-2"><span class="text-sm font-bold w-8">2nd</span><input type="text" name="rank_2" class="flex-1 border border-slate-300 rounded p-1" placeholder="Problem 2"></div>
                            <div class="flex items-center gap-2"><span class="text-sm font-bold w-8">3rd</span><input type="text" name="rank_3" class="flex-1 border border-slate-300 rounded p-1" placeholder="Problem 3"></div>
                            <div class="flex items-center gap-2"><span class="text-sm font-bold w-8">4th</span><input type="text" name="rank_4" class="flex-1 border border-slate-300 rounded p-1" placeholder="Problem 4"></div>
                            <div class="flex items-center gap-2"><span class="text-sm font-bold w-8">5th</span><input type="text" name="rank_5" class="flex-1 border border-slate-300 rounded p-1" placeholder="Problem 5"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION 9 -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="bg-slate-50 p-4 border-b border-slate-100 flex items-center gap-3">
                    <div class="section-badge w-8 h-8 rounded-lg flex items-center justify-center font-bold text-sm">9</div>
                    <div>
                        <h2 class="font-bold text-slate-800 text-sm uppercase">Toilet Acceptance</h2>
                        <p class="font-nepali text-xs text-slate-500">खण्ड ९: शौचालय स्वीकृति</p>
                    </div>
                </div>
                <div class="p-5 space-y-4">
                    <!-- Q27 -->
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">27. Biggest Benefit</label>
                        <select name="toilet_benefit" class="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 outline-none">
                            <option value="">Select...</option>
                            <option value="Safety">Safety (सुरक्षा)</option>
                            <option value="Privacy">Privacy (गोपनीयता)</option>
                            <option value="Health">Better health (स्वास्थ्य सुधार)</option>
                            <option value="Convenience">Convenience (सजिलो)</option>
                            <option value="Vulnerable">Safety for children/elderly</option>
                            <option value="Modern">Modern feeling (आधुनिकता)</option>
                            <option value="None">No benefit (फाइदा छैन)</option>
                        </select>
                        <input type="text" name="benefit_other" class="mt-2 w-full border border-slate-300 rounded p-2 text-sm" placeholder="Other...">
                    </div>
                    <!-- Q28 -->
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">28. Main Concern</label>
                        <select name="toilet_concern" class="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 outline-none">
                            <option value="">Select...</option>
                            <option value="No space">No space (ठाउँ छैन)</option>
                            <option value="Cost">High Cost (महँगो)</option>
                            <option value="No water">No water (पानी छैन)</option>
                            <option value="Emptying">Emptying issue (खाल्डो समस्या)</option>
                            <option value="Knowledge">Lack of knowledge (ज्ञान अभाव)</option>
                            <option value="Not used">Not used to it (अभ्यस्त छैन)</option>
                        </select>
                        <input type="text" name="concern_other" class="mt-2 w-full border border-slate-300 rounded p-2 text-sm" placeholder="Other...">
                    </div>
                    <!-- Q29 -->
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">29. Willingness to Use</label>
                        <select name="willingness" class="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 outline-none">
                            <option value="Yes">Yes, definitely (निश्चित)</option>
                            <option value="Probably Yes">Probably yes (सायद)</option>
                            <option value="Not sure">Not sure (निश्चित छैन)</option>
                            <option value="Probably No">Probably no (सायद होइन)</option>
                            <option value="No">No (होइन)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- SECTION 10 -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="bg-slate-50 p-4 border-b border-slate-100 flex items-center gap-3">
                    <div class="section-badge w-8 h-8 rounded-lg flex items-center justify-center font-bold text-sm">10</div>
                    <div>
                        <h2 class="font-bold text-slate-800 text-sm uppercase">Agriculture & Community</h2>
                        <p class="font-nepali text-xs text-slate-500">खण्ड १०: कृषि तथा सामुदायिक</p>
                    </div>
                </div>
                <div class="p-5 space-y-4">
                    <!-- Q30 -->
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">30. Fertilizer Use</label>
                        <select name="fertilizer" class="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 outline-none">
                            <option value="Chemical">Chemical only (रासायनिक मात्र)</option>
                            <option value="Dung">Cow/Buffalo dung (गोबर मल)</option>
                            <option value="Both">Both (दुबै)</option>
                            <option value="None">Do not use (प्रयोग गर्दिन)</option>
                        </select>
                    </div>
                    <!-- Q31 -->
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">31. Use Treated Human Waste?</label>
                        <select name="human_waste_use" class="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 outline-none">
                            <option value="Yes">Yes (छु)</option>
                            <option value="Maybe">Maybe (सायद)</option>
                            <option value="No-Religious">No, religious reason</option>
                            <option value="No-Disgust">No, I find it disgusting</option>
                        </select>
                    </div>
                    <!-- Q32 -->
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">32. Community Toilet Cleaning</label>
                        <select name="cleaning_mgmt" class="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 outline-none">
                            <option value="Women only">Women only (महिला मात्र)</option>
                            <option value="Men only">Men only (पुरुष मात्र)</option>
                            <option value="Both">Both Women and Men (दुवै)</option>
                            <option value="Rotation">Household rotation (घरधुरी पालैपालो)</option>
                            <option value="Committee">Committee (समिति)</option>
                        </select>
                    </div>
                    <!-- Q33 -->
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">33. Contribution Willingness</label>
                        <select name="contribution" class="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 outline-none">
                            <option value="Labor">Labor only (श्रमदान मात्र)</option>
                            <option value="Materials">Materials only (सामग्री मात्र)</option>
                            <option value="Both">Both (दुबै)</option>
                            <option value="No">No (छैन)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- SECTION 11 -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="bg-slate-50 p-4 border-b border-slate-100 flex items-center gap-3">
                    <div class="section-badge w-8 h-8 rounded-lg flex items-center justify-center font-bold text-sm">11</div>
                    <div>
                        <h2 class="font-bold text-slate-800 text-sm uppercase">Transportation Access</h2>
                        <p class="font-nepali text-xs text-slate-500">खण्ड ११: यातायात पहुँच</p>
                    </div>
                </div>
                <div class="p-5">
                    <!-- Q34 -->
                    <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">34. Nearest Road Access</label>
                    <select name="road_access" class="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 outline-none">
                        <option value="<5min">Within 5 minutes (५ मिनेट भित्र)</option>
                        <option value="5-15min">5–15 minutes (५–१५ मिनेट)</option>
                        <option value=">15min">More than 15 minutes (१५ मिनेट भन्दा बढी)</option>
                    </select>
                </div>
            </div>

            <!-- SECTION 12 OBSERVATION -->
            <div class="bg-yellow-50 rounded-2xl shadow-sm border border-yellow-200 overflow-hidden relative">
                <div class="absolute top-0 right-0 bg-yellow-200 text-yellow-800 text-[10px] font-bold px-3 py-1 rounded-bl-xl">STAFF ONLY</div>
                <div class="bg-yellow-100/80 p-4 border-b border-yellow-200 flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-yellow-300 text-yellow-900 flex items-center justify-center font-bold text-sm">12</div>
                    <div>
                        <h2 class="font-bold text-yellow-900 text-sm uppercase">Enumerator Observation</h2>
                        <p class="font-nepali text-xs text-yellow-700">खण्ड १२: गणकको अवलोकन</p>
                    </div>
                </div>
                <div class="p-5 space-y-4">
                    <!-- Checklist -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm text-yellow-900">
                        <label class="flex items-center gap-2"><input type="checkbox" name="obs_internet" class="accent-yellow-600"> Internet Service Available</label>
                        <label class="flex items-center gap-2"><input type="checkbox" name="obs_electricity" class="accent-yellow-600"> Electricity Available</label>
                        <label class="flex items-center gap-2"><input type="checkbox" name="obs_road_palika" class="accent-yellow-600"> Road access to Palika</label>
                        <label class="flex items-center gap-2"><input type="checkbox" name="obs_road_ward" class="accent-yellow-600"> Road access to Ward</label>
                        <label class="flex items-center gap-2"><input type="checkbox" name="obs_drr" class="accent-yellow-600"> DRR Issues (Landslide/Flood)</label>
                        <label class="flex items-center gap-2"><input type="checkbox" name="obs_women_grp" class="accent-yellow-600"> Family in Women's Group</label>
                        <label class="flex items-center gap-2"><input type="checkbox" name="obs_youth_club" class="accent-yellow-600"> Family in Youth Club</label>
                        <label class="flex items-center gap-2"><input type="checkbox" name="obs_child_club" class="accent-yellow-600"> Family in Child Club</label>
                        <label class="flex items-center gap-2"><input type="checkbox" name="obs_finance" class="accent-yellow-600"> Financial Inst. Nearby</label>
                        <label class="flex items-center gap-2"><input type="checkbox" name="obs_gov_school" class="accent-yellow-600"> Gov School Nearby</label>
                        <label class="flex items-center gap-2"><input type="checkbox" name="obs_pvt_school" class="accent-yellow-600"> Pvt School Nearby</label>
                        <label class="flex items-center gap-2"><input type="checkbox" name="obs_health" class="accent-yellow-600"> Health Post Nearby</label>
                    </div>
                    
                    <hr class="border-yellow-200">

                    <!-- House Condition -->
                    <div>
                        <label class="text-xs font-bold text-yellow-900 uppercase mb-2 block">House Condition</label>
                        <div class="flex gap-1">
                            <label class="flex-1 cursor-pointer"><input type="radio" name="house_condition" value="Very Poor" class="peer hidden"><div class="text-center py-2 bg-white border border-yellow-300 rounded text-xs peer-checked:bg-yellow-500 peer-checked:text-white">Very Poor</div></label>
                            <label class="flex-1 cursor-pointer"><input type="radio" name="house_condition" value="Poor" class="peer hidden"><div class="text-center py-2 bg-white border border-yellow-300 rounded text-xs peer-checked:bg-yellow-500 peer-checked:text-white">Poor</div></label>
                            <label class="flex-1 cursor-pointer"><input type="radio" name="house_condition" value="Average" class="peer hidden"><div class="text-center py-2 bg-white border border-yellow-300 rounded text-xs peer-checked:bg-yellow-500 peer-checked:text-white">Average</div></label>
                            <label class="flex-1 cursor-pointer"><input type="radio" name="house_condition" value="Good" class="peer hidden"><div class="text-center py-2 bg-white border border-yellow-300 rounded text-xs peer-checked:bg-yellow-500 peer-checked:text-white">Good</div></label>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-2 text-center">
                        <label class="block p-2 bg-white rounded border border-yellow-200 text-xs text-yellow-900"><input type="checkbox" name="obs_toilet_visible" class="block mx-auto mb-1">Toilet Visible?</label>
                        <label class="block p-2 bg-white rounded border border-yellow-200 text-xs text-yellow-900"><input type="checkbox" name="obs_water_visible" class="block mx-auto mb-1">Water Visible?</label>
                        <label class="block p-2 bg-white rounded border border-yellow-200 text-xs text-yellow-900"><input type="checkbox" name="obs_photo" class="block mx-auto mb-1">Photo Taken?</label>
                    </div>

                    <!-- Meta -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-2">
                        <div>
                            <label class="text-xs font-bold text-yellow-900 uppercase mb-1 block">Enumerator Name</label>
                            <input type="text" name="enumerator_name" required class="w-full p-2 rounded text-sm border border-yellow-300 outline-none">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-yellow-900 uppercase mb-1 block">Date</label>
                            <input type="date" name="survey_date" required class="w-full p-2 rounded text-sm border border-yellow-300 bg-white outline-none">
                        </div>
                    </div>

                    <!-- Signature -->
                    <div>
                        <label class="text-xs font-bold text-yellow-900 uppercase mb-1 block">Enumerator Signature</label>
                        <div class="border-2 border-dashed border-yellow-400 bg-white rounded-xl overflow-hidden relative">
                            <canvas id="signature-pad" width="300" height="120" class="w-full h-32 cursor-crosshair"></canvas>
                            <button type="button" onclick="clearSignature()" class="absolute top-2 right-2 text-[10px] bg-slate-200 px-2 py-1 rounded hover:bg-slate-300">Clear</button>
                        </div>
                        <input type="hidden" name="signature_data" id="signature_data">
                    </div>
                </div>
            </div>

            <!-- Footer Buttons -->
            <div class="fixed bottom-0 left-0 right-0 p-4 bg-white/90 backdrop-blur-lg border-t border-slate-200 flex gap-3 max-w-4xl mx-auto z-40 shadow-2xl">
                <button type="button" onclick="if(confirm('Reset form?')) { document.getElementById('surveyForm').reset(); clearSignature(); clearDraft(); window.scrollTo(0,0); }" class="px-4 py-3 bg-slate-100 text-slate-600 font-bold rounded-xl hover:bg-slate-200 transition">
                    <i class="fas fa-undo"></i>
                </button>
                <button type="submit" id="submitBtn" class="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold text-lg rounded-xl shadow-lg shadow-blue-200 hover:shadow-blue-300 transition-all flex items-center justify-center gap-2 py-3">
                    <span>Save Survey</span>
                    <i class="fas fa-save"></i>
                </button>
            </div>
        </form>
    </div>

    <!-- DASHBOARD VIEW -->
    <div id="dashboard-view" class="view-section max-w-4xl mx-auto p-4 space-y-6">
        
        <!-- Stats Summary (NEW) -->
        <div class="grid grid-cols-2 gap-4">
            <div class="bg-gradient-to-br from-blue-500 to-blue-700 text-white p-5 rounded-2xl shadow-lg relative overflow-hidden">
                <i class="fas fa-database absolute -bottom-4 -right-4 text-7xl text-white/20"></i>
                <p class="text-blue-100 text-xs font-bold uppercase tracking-wider">Total Records</p>
                <p id="totalCount" class="text-4xl font-bold mt-1">0</p>
            </div>
            <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm flex flex-col justify-center">
                 <p class="text-xs text-slate-500 font-bold uppercase mb-2">Quick Stats</p>
                 <div class="flex justify-between items-center mb-2">
                     <span class="text-sm">Toilet Coverage</span>
                     <span id="statToilet" class="font-bold text-blue-600">0%</span>
                 </div>
                 <div class="w-full bg-slate-100 rounded-full h-2 overflow-hidden">
                     <div id="progToilet" class="bg-blue-500 h-2 rounded-full" style="width: 0%"></div>
                 </div>
                 <div class="mt-2 text-[10px] text-slate-400 text-center">Based on stored data</div>
            </div>
        </div>
        
        <!-- Search Bar (NEW) -->
        <div class="relative">
            <i class="fas fa-search absolute left-3 top-3 text-slate-400"></i>
            <input type="text" id="searchInput" onkeyup="searchRecords()" placeholder="Search Name, Tole, or Enumerator..." class="w-full pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 shadow-sm focus:border-blue-500 outline-none">
        </div>

        <div>
            <div class="flex justify-between items-end mb-3 px-1">
                <h3 class="font-bold text-slate-800 text-lg">Saved Entries</h3>
                <button onclick="clearAllData()" class="text-[10px] text-red-500 font-bold hover:text-red-700 bg-red-50 px-3 py-1.5 rounded-full uppercase tracking-wide">Clear All</button>
            </div>
            <div id="dashboardList" class="space-y-3 pb-20">
                <!-- Items injected here -->
            </div>
        </div>

        <!-- Float Export Button -->
        <button onclick="exportLocal()" class="fixed bottom-24 right-4 bg-green-600 text-white p-4 rounded-full shadow-xl hover:bg-green-700 active:scale-95 transition z-40">
            <i class="fas fa-file-excel text-xl"></i>
        </button>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[60] flex items-center justify-center p-4 fade-in">
        <div class="bg-white rounded-3xl p-6 w-full max-w-sm text-center shadow-2xl scale-100">
            <div class="w-16 h-16 bg-green-100 text-green-500 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl shadow-inner">
                <i class="fas fa-check"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-900 mb-1">Saved Successfully</h3>
            <p class="text-slate-500 text-sm mb-6">Survey stored on this device.</p>
            <div class="space-y-3">
                <button onclick="closeModal()" class="w-full bg-slate-900 text-white font-bold py-3.5 rounded-xl hover:bg-slate-800 transition active:scale-95">Start New Survey</button>
                <button onclick="toggleView(); closeModal();" class="w-full text-slate-600 font-semibold py-2 text-sm hover:text-slate-900">Go to Dashboard</button>
            </div>
        </div>
    </div>
    
    <!-- Detail View Modal (NEW) -->
    <div id="detailModal" class="hidden fixed inset-0 bg-white z-[70] overflow-y-auto fade-in">
        <div class="sticky top-0 bg-white border-b border-slate-200 p-4 flex justify-between items-center z-10">
            <h2 class="font-bold text-lg">Survey Details</h2>
            <button onclick="closeDetailModal()" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 hover:bg-slate-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="detailContent" class="p-5 space-y-4 pb-20 text-sm">
            <!-- Content Injected via JS -->
        </div>
    </div>

    <script>
        const DB_KEY = 'sanitation_db_full_v3';
        const DRAFT_KEY = 'sanitation_draft_v3';
        
        // --- Signature Pad ---
        const canvas = document.getElementById('signature-pad');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;

        function getPos(canvas, evt) {
            const rect = canvas.getBoundingClientRect();
            const x = (evt.clientX || evt.touches[0].clientX) - rect.left;
            const y = (evt.clientY || evt.touches[0].clientY) - rect.top;
            return { x, y };
        }

        function startDraw(e) { e.preventDefault(); isDrawing = true; const pos = getPos(canvas, e); ctx.beginPath(); ctx.moveTo(pos.x, pos.y); }
        function draw(e) { if (!isDrawing) return; e.preventDefault(); const pos = getPos(canvas, e); ctx.lineTo(pos.x, pos.y); ctx.stroke(); }
        function endDraw() { if(isDrawing) { isDrawing = false; document.getElementById('signature_data').value = "Signed"; saveDraftDebounced(); } }

        canvas.addEventListener('mousedown', startDraw);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', endDraw);
        canvas.addEventListener('touchstart', startDraw);
        canvas.addEventListener('touchmove', draw);
        canvas.addEventListener('touchend', endDraw);

        function clearSignature() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            document.getElementById('signature_data').value = "";
        }

        // --- GPS Logic ---
        let watchId = null;
        let bestAccuracy = Infinity;
        let bestCoords = null;
        let gpsTimeout = null;
        let updateCount = 0;

        function getGPS() {
            const status = document.getElementById('gps_status');
            const input = document.getElementById('gps_input');
            const btnTrack = document.getElementById('btn_track');
            const btnStop = document.getElementById('btn_stop');
            
            if (watchId) navigator.geolocation.clearWatch(watchId);
            if (gpsTimeout) clearTimeout(gpsTimeout);
            bestAccuracy = Infinity;
            bestCoords = null;
            updateCount = 0;
            
            btnTrack.classList.add('hidden');
            btnStop.classList.remove('hidden');
            input.value = "Acquiring satellites...";
            status.innerHTML = '<span class="text-blue-600"><i class="fas fa-spinner fa-spin"></i> Warming up GPS...</span>';

            if (!navigator.geolocation) {
                finishGPS(false);
                status.innerText = "GPS not supported.";
                return;
            }

            const options = { enableHighAccuracy: true, timeout: 45000, maximumAge: 0 };

            watchId = navigator.geolocation.watchPosition(
                (pos) => {
                    updateCount++;
                    const currentAcc = pos.coords.accuracy;
                    const lat = pos.coords.latitude.toFixed(7);
                    const lng = pos.coords.longitude.toFixed(7);
                    
                    if (currentAcc < bestAccuracy) {
                        bestAccuracy = currentAcc;
                        bestCoords = `${lat}, ${lng}`;
                        input.value = bestCoords; 
                        saveDraftDebounced(); // Save draft when GPS updates
                    }

                    let color = 'text-orange-500';
                    if (bestAccuracy < 10) color = 'text-blue-500';
                    if (bestAccuracy <= 5) color = 'text-green-600';

                    status.innerHTML = `<span class="${color} font-mono"><i class="fas fa-crosshairs"></i> Best: <b>${bestAccuracy.toFixed(1)}m</b></span> <span class="text-slate-400 mx-1">|</span> <span class="text-slate-500">Pinging... (${updateCount})</span>`;
                    
                    if (bestAccuracy <= 3) finishGPS(true);
                },
                (err) => {
                     if (bestAccuracy === Infinity) {
                         status.innerText = "Signal Error: " + err.message;
                         finishGPS(false);
                     }
                },
                options
            );

            gpsTimeout = setTimeout(() => {
                finishGPS(true);
                if(bestAccuracy === Infinity) status.innerText = "Timeout: No signal found.";
            }, 45000);
        }

        function finishGPS(saveResult) {
            if (watchId) navigator.geolocation.clearWatch(watchId);
            if (gpsTimeout) clearTimeout(gpsTimeout);
            watchId = null;

            document.getElementById('btn_track').classList.remove('hidden');
            document.getElementById('btn_stop').classList.add('hidden');
            document.getElementById('btn_track').innerHTML = '<i class="fas fa-redo mr-1"></i> Retrack';

            if (saveResult && bestCoords) {
                document.getElementById('gps_input').value = bestCoords;
                document.getElementById('gps_status').innerHTML = `<span class="text-green-700 font-bold"><i class="fas fa-check-circle"></i> Locked at ${bestAccuracy.toFixed(1)}m accuracy</span>`;
            } else if (!bestCoords) {
                document.getElementById('gps_input').value = "";
                document.getElementById('gps_status').innerText = "GPS cancelled or failed.";
            }
            saveDraftDebounced();
        }

        // --- AutoSave Draft Logic ---
        let saveTimeout;
        function saveDraftDebounced() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveDraft, 1000);
        }

        function saveDraft() {
            const formData = new FormData(document.getElementById('surveyForm'));
            const data = {};
            formData.forEach((value, key) => {
                if(!data[key]) {
                    data[key] = value;
                } else {
                    if(!Array.isArray(data[key])){ data[key] = [data[key]]; }
                    data[key].push(value);
                }
            });
            // Handle checkboxes specifically if needed, but FormData handles them well for restore if we are careful
            localStorage.setItem(DRAFT_KEY, JSON.stringify(data));
            
            const indicator = document.getElementById('draftStatus');
            indicator.classList.remove('hidden');
            setTimeout(() => indicator.classList.add('hidden'), 2000);
        }

        function checkDraft() {
            const draft = localStorage.getItem(DRAFT_KEY);
            if(draft) {
                document.getElementById('restoreDraftAlert').classList.remove('hidden');
            }
        }

        function restoreDraft() {
            const draft = JSON.parse(localStorage.getItem(DRAFT_KEY));
            if(!draft) return;
            
            const form = document.getElementById('surveyForm');
            
            // Loop through draft keys
            for (const key in draft) {
                const value = draft[key];
                const inputs = form.querySelectorAll(`[name="${key}"]`);
                
                if(inputs.length > 0) {
                    if(inputs[0].type === 'radio') {
                        inputs.forEach(input => {
                            if(input.value === value) input.checked = true;
                        });
                    } else if(inputs[0].type === 'checkbox') {
                         if(Array.isArray(value)) {
                             inputs.forEach(input => {
                                 if(value.includes(input.value)) input.checked = true;
                             });
                         } else {
                             inputs.forEach(input => {
                                 if(input.value === value) input.checked = true;
                             });
                         }
                    } else {
                        inputs[0].value = value;
                    }
                }
            }
            document.getElementById('restoreDraftAlert').classList.add('hidden');
        }

        function clearDraft() {
            localStorage.removeItem(DRAFT_KEY);
            document.getElementById('restoreDraftAlert').classList.add('hidden');
        }


        // --- Form Handling ---
        document.getElementById('surveyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const oldHtml = btn.innerHTML;
            btn.disabled = true; btn.innerHTML = 'Saving...';

            try {
                const formData = new FormData(e.target);
                const getMulti = (name) => Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(cb => cb.value).join(', ');
                
                // Detailed Education Matrix Extraction
                const eduMatrix = {
                     no_edu: `Child:${formData.get('edu_no_child')}, Adult:${formData.get('edu_no_adult')}, Elder:${formData.get('edu_no_elder')}`,
                     primary: `Child:${formData.get('edu_pri_child')}, Adult:${formData.get('edu_pri_adult')}, Elder:${formData.get('edu_pri_elder')}`,
                     lower: `Child:${formData.get('edu_low_child')}, Adult:${formData.get('edu_low_adult')}, Elder:${formData.get('edu_low_elder')}`,
                     secondary: `Child:${formData.get('edu_sec_child')}, Adult:${formData.get('edu_sec_adult')}, Elder:${formData.get('edu_sec_elder')}`,
                     higher: `Child:${formData.get('edu_high_child')}, Adult:${formData.get('edu_high_adult')}, Elder:${formData.get('edu_high_elder')}`,
                     bachelor: `Child:${formData.get('edu_bach_child')}, Adult:${formData.get('edu_bach_adult')}, Elder:${formData.get('edu_bach_elder')}`,
                     total: `Child:${formData.get('edu_tot_child')}, Adult:${formData.get('edu_tot_adult')}, Elder:${formData.get('edu_tot_elder')}`,
                };

                const data = {
                    id: Date.now(),
                    date: new Date().toISOString(),
                    
                    consent: formData.get('consent'),
                    respondent: formData.get('respondent_name'),
                    settlement: formData.get('settlement'),
                    houseNo: formData.get('house_number'),
                    gender: formData.get('gender'),
                    age: formData.get('age'),
                    religion: formData.get('religion'),
                    marital: formData.get('marital_status'),
                    caste: formData.get('caste'),
                    gps: formData.get('gps_coords'),
                    
                    totalMembers: formData.get('total_members'),
                    leadingMember: formData.get('leading_member'),
                    familyType: formData.get('family_type'),
                    
                    incomeSources: getMulti('income_source'),
                    incomeOther: formData.get('income_other'),
                    monthlyIncome: formData.get('monthly_income'),
                    
                    edu_NoEdu: eduMatrix.no_edu,
                    edu_Primary: eduMatrix.primary,
                    edu_LowerSec: eduMatrix.lower,
                    edu_Secondary: eduMatrix.secondary,
                    edu_HigherSec: eduMatrix.higher,
                    edu_Bachelor: eduMatrix.bachelor,
                    edu_Total: eduMatrix.total,
                    
                    migration: formData.get('migration'),
                    foodSecurity: formData.get('food_security'),
                    
                    houseMaterial: formData.get('house_material'),
                    matOther: formData.get('material_other'),
                    landOwn: formData.get('land_ownership'),
                    
                    waterSource: formData.get('water_source'),
                    waterOther: formData.get('water_source_other'),
                    waterAvail: formData.get('water_avail'),
                    waterDist: formData.get('water_dist'),
                    
                    toiletPrac: formData.get('toilet_practice'),
                    pracOther: formData.get('practice_other'),
                    womenChal: formData.get('women_challenges'),
                    wc_types: getMulti('wc_type'),
                    wc_other: formData.get('wc_other'),
                    
                    challenges: getMulti('challenges'),
                    chalOther: formData.get('challenge_other'),
                    rank1: formData.get('rank_1'),
                    rank2: formData.get('rank_2'),
                    rank3: formData.get('rank_3'),
                    rank4: formData.get('rank_4'),
                    rank5: formData.get('rank_5'),
                    
                    benefit: formData.get('toilet_benefit'),
                    benOther: formData.get('benefit_other'),
                    concern: formData.get('toilet_concern'),
                    conOther: formData.get('concern_other'),
                    willingness: formData.get('willingness'),
                    
                    fertilizer: formData.get('fertilizer'),
                    humanWaste: formData.get('human_waste_use'),
                    cleaning: formData.get('cleaning_mgmt'),
                    contrib: formData.get('contribution'),
                    
                    road: formData.get('road_access'),
                    
                    obs_internet: formData.get('obs_internet') ? 'Yes' : 'No',
                    obs_elec: formData.get('obs_electricity') ? 'Yes' : 'No',
                    obs_roadP: formData.get('obs_road_palika') ? 'Yes' : 'No',
                    obs_roadW: formData.get('obs_road_ward') ? 'Yes' : 'No',
                    obs_drr: formData.get('obs_drr') ? 'Yes' : 'No',
                    obs_wgrp: formData.get('obs_women_grp') ? 'Yes' : 'No',
                    obs_yclub: formData.get('obs_youth_club') ? 'Yes' : 'No',
                    obs_cclub: formData.get('obs_child_club') ? 'Yes' : 'No',
                    obs_fin: formData.get('obs_finance') ? 'Yes' : 'No',
                    obs_gsch: formData.get('obs_gov_school') ? 'Yes' : 'No',
                    obs_psch: formData.get('obs_pvt_school') ? 'Yes' : 'No',
                    obs_hp: formData.get('obs_health') ? 'Yes' : 'No',
                    
                    houseCond: formData.get('house_condition'),
                    obs_toilet: formData.get('obs_toilet_visible') ? 'Yes' : 'No',
                    obs_water: formData.get('obs_water_visible') ? 'Yes' : 'No',
                    obs_photo: formData.get('obs_photo') ? 'Yes' : 'No',
                    
                    enumerator: formData.get('enumerator_name'),
                    surveyDate: formData.get('survey_date'),
                    signed: formData.get('signature_data') ? 'Yes' : 'No'
                };

                const existing = JSON.parse(localStorage.getItem(DB_KEY) || '[]');
                existing.unshift(data);
                localStorage.setItem(DB_KEY, JSON.stringify(existing));
                
                clearDraft(); // Clear draft on successful save
                document.getElementById('successModal').classList.remove('hidden');
                
            } catch (err) {
                alert("Error: " + err.message);
            } finally {
                btn.disabled = false; btn.innerHTML = oldHtml;
            }
        });

        // --- Navigation ---
        function toggleView() {
            const form = document.getElementById('survey-view');
            const dash = document.getElementById('dashboard-view');
            const btn = document.getElementById('navBtn');
            
            if (form.classList.contains('active')) {
                form.classList.remove('active');
                dash.classList.add('active');
                btn.innerHTML = '<i class="fas fa-pen"></i> Form';
                loadDashboard();
            } else {
                dash.classList.remove('active');
                form.classList.add('active');
                btn.innerHTML = '<i class="fas fa-th-large"></i> Dashboard';
            }
            window.scrollTo(0,0);
        }

        let allData = [];
        function loadDashboard() {
            allData = JSON.parse(localStorage.getItem(DB_KEY) || '[]');
            document.getElementById('totalCount').innerText = allData.length;
            
            // Calculate Stats
            const total = allData.length || 1;
            const hasToilet = allData.filter(d => d.toiletPrac === 'Own Toilet' || d.toiletPrac === 'Shared Toilet').length;
            const toiletPerc = Math.round((hasToilet / total) * 100);
            
            document.getElementById('statToilet').innerText = toiletPerc + "%";
            document.getElementById('progToilet').style.width = toiletPerc + "%";

            renderList(allData);
        }

        function searchRecords() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allData.filter(d => 
                (d.respondent || '').toLowerCase().includes(term) ||
                (d.settlement || '').toLowerCase().includes(term) ||
                (d.enumerator || '').toLowerCase().includes(term)
            );
            renderList(filtered);
        }

        function renderList(data) {
            const list = document.getElementById('dashboardList');
            if(data.length === 0) {
                list.innerHTML = '<div class="text-center py-10 text-slate-400 border border-dashed rounded-lg">No matching records</div>';
                return;
            }

            list.innerHTML = data.map(d => `
                <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm transition hover:shadow-md">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h4 class="font-bold text-slate-800">${d.respondent || 'Anonymous'}</h4>
                            <div class="text-xs text-slate-500 mt-0.5">
                                <i class="fas fa-map-marker-alt mr-1"></i> ${d.settlement || '-'}
                            </div>
                        </div>
                        <button onclick="viewDetail(${d.id})" class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded-lg font-bold hover:bg-blue-100">
                            View
                        </button>
                    </div>
                    <div class="flex items-center justify-between text-[10px] text-slate-400 border-t border-slate-50 pt-2 mt-2">
                        <span><i class="fas fa-user mr-1"></i> ${d.enumerator || '-'}</span>
                        <span>${new Date(d.date).toLocaleDateString()}</span>
                    </div>
                </div>
            `).join('');
        }
        
        // --- View Detail Modal ---
        function viewDetail(id) {
            const record = allData.find(d => d.id === id);
            if(!record) return;
            
            const content = document.getElementById('detailContent');
            let html = '';
            for (const [key, value] of Object.entries(record)) {
                if(value && key !== 'id') {
                     html += `
                        <div class="border-b border-slate-100 pb-2 last:border-0">
                            <span class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">${key.replace(/_/g, ' ')}</span>
                            <span class="block text-slate-800 font-medium">${value}</span>
                        </div>
                     `;
                }
            }
            content.innerHTML = html;
            document.getElementById('detailModal').classList.remove('hidden');
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.add('hidden');
        }

        function exportLocal() {
            const rawData = JSON.parse(localStorage.getItem(DB_KEY) || '[]');
            if(!rawData.length) { alert("No data to export"); return; }

            // 1. Format Data
            const formattedData = rawData.map(item => ({
                "Survey ID": item.id,
                "Date Time": new Date(item.date).toLocaleString(), // Better date format
                "Enumerator": item.enumerator,
                "Settlement": item.settlement,
                "House No": item.houseNo,
                "Respondent": item.respondent,
                "Consent": item.consent,
                "GPS Coordinates": item.gps,
                "Gender": item.gender,
                "Age": item.age,
                "Religion": item.religion,
                "Marital Status": item.marital,
                "Caste/Ethnicity": item.caste,
                
                "Total Members": item.totalMembers,
                "Leading Member": item.leadingMember,
                "Family Type": item.familyType,
                
                "Income Sources": item.incomeSources,
                "Other Income": item.incomeOther,
                "Monthly Income": item.monthlyIncome,
                
                "Edu: No Formal": item.edu_NoEdu,
                "Edu: Primary": item.edu_Primary,
                "Edu: Lower Sec": item.edu_LowerSec,
                "Edu: Secondary": item.edu_Secondary,
                "Edu: Higher Sec": item.edu_HigherSec,
                "Edu: Bachelor+": item.edu_Bachelor,
                "Edu: Totals": item.edu_Total,

                "Migration": item.migration,
                "Food Security": item.foodSecurity,
                
                "House Material": item.houseMaterial,
                "Other Material": item.matOther,
                "Land Ownership": item.landOwn,
                
                "Water Source": item.waterSource,
                "Other Water": item.waterOther,
                "Water Availability": item.waterAvail,
                "Water Distance": item.waterDist,
                
                "Toilet Practice": item.toiletPrac,
                "Other Practice": item.pracOther,
                "Women Challenges": item.womenChal,
                "Challenge Types": item.wc_types,
                "Challenge Other": item.wc_other,
                
                "Major Challenges": item.challenges,
                "Other Challenge": item.chalOther,
                "Priority 1": item.rank1,
                "Priority 2": item.rank2,
                "Priority 3": item.rank3,
                "Priority 4": item.rank4,
                "Priority 5": item.rank5,
                
                "Toilet Benefit": item.benefit,
                "Other Benefit": item.benOther,
                "Toilet Concern": item.concern,
                "Other Concern": item.conOther,
                "Willingness to Use": item.willingness,
                
                "Fertilizer Use": item.fertilizer,
                "Human Waste Use": item.humanWaste,
                "Cleaning Mgmt": item.cleaning,
                "Contribution": item.contrib,
                "Road Access": item.road,
                
                "Obs: Internet": item.obs_internet,
                "Obs: Electricity": item.obs_elec,
                "Obs: Road (Palika)": item.obs_roadP,
                "Obs: Road (Ward)": item.obs_roadW,
                "Obs: DRR Issues": item.obs_drr,
                "Obs: Women Group": item.obs_wgrp,
                "Obs: Youth Club": item.obs_yclub,
                "Obs: Child Club": item.obs_cclub,
                "Obs: Finance": item.obs_fin,
                "Obs: Gov School": item.obs_gsch,
                "Obs: Pvt School": item.obs_psch,
                "Obs: Health Post": item.obs_hp,
                "House Condition": item.houseCond,
                "Toilet Visible": item.obs_toilet,
                "Water Visible": item.obs_water,
                "Photo Taken": item.obs_photo,
                "Signed": item.signed
            }));

            const wb = XLSX.utils.book_new();

            // --- Sheet 1: Detailed Data ---
            const ws = XLSX.utils.json_to_sheet(formattedData);
            
            // Auto-width Calculation
            const wscols = [];
            const headers = Object.keys(formattedData[0]);
            
            headers.forEach((header) => {
                let maxLength = header.length;
                // Check up to 50 rows to determine width
                const checkRows = Math.min(formattedData.length, 50);
                for(let r=0; r<checkRows; r++) {
                    const val = formattedData[r][header];
                    const len = val ? String(val).length : 0;
                    if(len > maxLength) maxLength = len;
                }
                // Cap width at 50 chars to keep it readable
                wscols.push({ wch: Math.min(maxLength + 2, 50) });
            });
            ws['!cols'] = wscols;
            XLSX.utils.book_append_sheet(wb, ws, "Raw Data");

            // --- Sheet 2: Summary Stats (New Feature) ---
            const total = rawData.length;
            const toiletCount = rawData.filter(d => d.toiletPrac === 'Own Toilet' || d.toiletPrac === 'Shared Toilet').length;
            const waterTapCount = rawData.filter(d => d.waterSource === 'Tap').length;
            
            const summaryData = [
                ["SUMMARY REPORT", ""],
                ["Generated On", new Date().toLocaleString()],
                ["", ""],
                ["Total Households Surveyed", total],
                ["Households with Toilet Access", `${toiletCount} (${total > 0 ? Math.round(toiletCount/total*100) : 0}%)`],
                ["Households with Tap Water", `${waterTapCount} (${total > 0 ? Math.round(waterTapCount/total*100) : 0}%)`]
            ];
            
            const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
            wsSummary['!cols'] = [{wch: 30}, {wch: 30}];
            XLSX.utils.book_append_sheet(wb, wsSummary, "Summary");

            // Export
            const dateStr = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `Sanitation_Survey_${dateStr}.xlsx`);
        }

        function clearAllData() {
            if(confirm("Delete ALL saved surveys?")) {
                localStorage.removeItem(DB_KEY);
                loadDashboard();
            }
        }
        
        function closeModal() {
            document.getElementById('successModal').classList.add('hidden');
            document.getElementById('surveyForm').reset();
            clearSignature();
            document.querySelector('input[name="survey_date"]').valueAsDate = new Date();
            window.scrollTo(0,0);
        }
        
        function updateProgress() {
            const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
            const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
            const scrolled = (winScroll / height) * 100;
            document.getElementById("progress-bar").style.width = scrolled + "%";
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelector('input[name="survey_date"]').valueAsDate = new Date();
            checkDraft();
        });
    </script>
</body>
</html>
